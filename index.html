<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Complete Japanese Kana Practice</title>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CR8D4QH6FF"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-CR8D4QH6FF');
    </script>
    <!-- End Google Analytics -->
    
    <!-- i18next internationalization library -->
    <script src="https://unpkg.com/i18next/dist/umd/i18next.min.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/config.js"></script>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { 
            font-family: "Helvetica", "Yu Gothic", sans-serif; 
            text-align: center; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .page-content {
            display: block;
        }
        .page-content.hidden {
            display: none;
        }
        .container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; margin-bottom: 30px; }
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }
        .nav-tab {
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 8px;
            margin: 0 5px;
            transition: all 0.3s;
            font-weight: 500;
        }
        .nav-tab.active {
            background: #667eea;
            color: white;
        }
        .nav-tab:hover {
            background: #e9ecef;
        }
        .nav-tab.active:hover {
            background: #5a6fd8;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        input, button, select { 
            padding: 12px; 
            font-size: 16px; 
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 5px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        .kana { 
            font-size: 72px; 
            margin: 20px; 
            color: #2c3e50;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .result { 
            font-size: 18px; 
            margin-top: 20px; 
            font-weight: 500;
        }
        .quiz-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 30px; 
            margin-top: 30px; 
        }
        .mode-select { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .mode-select label { 
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .mode-select label:hover {
            background: #e9ecef;
        }
        .checkbox-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; 
            margin: 20px 0;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .checkbox-group { 
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .checkbox-group:hover {
            border-color: #667eea;
        }
        .checkbox-group h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 16px;
        }
        .checkbox-group label { 
            display: block;
            margin: 8px 0;
            text-align: left;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .checkbox-group label:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        .chart-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .chart-table th, .chart-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .chart-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        .chart-table td {
            font-size: 18px;
            transition: background 0.2s;
        }
        .chart-table td:hover {
            background: #f8f9fa;
        }
        .kana-char {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .romaji {
            font-size: 14px;
            color: #666;
            font-family: monospace;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            min-width: 120px;
            margin: 5px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        @media (max-width: 768px) {
            .container { margin: 10px; padding: 20px; }
            .kana { font-size: 48px; }
            .checkbox-grid { grid-template-columns: 1fr; }
            .quiz-container { flex-direction: column; gap: 15px; }
        }
        
        /* Ë™çË≠âÁõ∏ÈóúÊ®£Âºè */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 30px;
            background: rgba(255,255,255,0.98);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
        }
        
        .auth-tab {
            flex: 1;
            padding: 8px 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .auth-tab.active {
            background: #667eea;
            color: white;
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .auth-button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .auth-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        
        .auth-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        
        /* Google OAuth Ê®£Âºè */
        .oauth-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }
        
        .oauth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e9ecef;
        }
        
        .oauth-divider span {
            background: white;
            padding: 0 15px;
            color: #6c757d;
            font-size: 14px;
        }
        
        .google-login-btn {
            width: 100%;
            padding: 12px;
            background: white;
            color: #3c4043;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .google-login-btn:hover {
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            background: #f8f9fa;
        }
        
        .google-login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .success-message {
            color: #27ae60;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .user-details {
            flex: 1;
            text-align: left;
        }
        
        .user-name {
            font-weight: 500;
            margin: 0;
        }
        
        .user-email {
            font-size: 12px;
            color: #666;
            margin: 0;
        }
        
        .logout-btn {
            padding: 6px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        .auth-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
        }
        
        .auth-btn:hover {
            background: #5a6fd8;
        }
        
        .password-input-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .password-toggle:hover {
            color: #333;
        }
        
        .password-requirements {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin-top: 5px;
            font-size: 12px;
        }
        
        .password-requirement {
            display: flex;
            align-items: center;
            margin: 4px 0;
            color: #666;
        }
        
        .password-requirement .icon {
            margin-right: 6px;
            width: 16px;
            text-align: center;
        }
        
        .requirement-met {
            color: #27ae60;
        }
        
        .requirement-not-met {
            color: #e74c3c;
        }
        
        /* Ë©≥ÊÉÖÊ®°ÊÖãË¶ñÁ™óÊ®£Âºè */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .answer-record {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .answer-correct {
            background: rgba(39, 174, 96, 0.1);
            border-left: 4px solid #27ae60;
        }
        
        .answer-incorrect {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
        }
        
        .kana-large {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Ë™çË≠âÁïåÈù¢ -->
    <div id="auth-screen" class="container hidden">
        <!-- È†ÇÈÉ®Â∞éËà™ÂçÄ -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="showGuestApp()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                ‚Üê <span id="back-to-guest"></span>
            </button>
            
            <!-- Authentication page language selection -->
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="auth-language" style="font-size: 14px; color: #666;">üåê</label>
                <select id="auth-language" onchange="setLanguageAndUpdateAuth()" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="zh">‰∏≠Êñá</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>
        
        <h1 id="auth-title"></h1>
        <p style="margin: -10px 0 30px 0; color: #666; font-size: 14px;" id="auth-author">Author: Ingee</p>
        
        <div class="auth-container">
            <div class="auth-tabs">
                <div class="auth-tab active" data-auth-tab="login" id="login-tab"></div>
                <div class="auth-tab" data-auth-tab="register" id="register-tab"></div>
            </div>
            
            <!-- ÁôªÂÖ•Ë°®ÂñÆ -->
            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="login-identifier" id="login-identifier-label"></label>
                    <input type="text" id="login-identifier" required>
                </div>
                <div class="form-group">
                    <label for="login-password" id="login-password-label"></label>
                    <div class="password-input-container">
                        <input type="password" id="login-password" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('login-password')">üëÅ</button>
                    </div>
                </div>
                <button type="submit" class="auth-button" id="login-button"></button>
                <div id="login-message"></div>
                
                <!-- Google Login Section -->
                <div class="oauth-divider">
                    <span id="oauth-divider-text"></span>
                </div>
                <div id="google-signin-button"></div>
            </form>
            
            <!-- Ë®ªÂÜäË°®ÂñÆ -->
            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <label for="register-username" id="register-username-label"></label>
                    <input type="text" id="register-username" required minlength="3">
                </div>
                <div class="form-group">
                    <label for="register-email" id="register-email-label"></label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-display-name" id="register-display-name-label"></label>
                    <input type="text" id="register-display-name" placeholder="">
                </div>
                <div class="form-group">
                    <label for="register-language" id="register-language-label"></label>
                    <select id="register-language" onchange="onLanguagePreferenceChange()" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; box-sizing: border-box;">
                    </select>
                </div>
                <div class="form-group">
                    <label for="register-password" id="register-password-label"></label>
                    <div class="password-input-container">
                        <input type="password" id="register-password" required minlength="8" oninput="validatePassword()">
                        <button type="button" class="password-toggle" onclick="togglePassword('register-password')">üëÅ</button>
                    </div>
                    <div class="password-requirements" id="password-requirements">
                        <div class="password-requirement" id="req-length">
                            <span class="icon">‚ùå</span>
                            <span id="req-length-text"></span>
                        </div>
                        <div class="password-requirement" id="req-letter">
                            <span class="icon">‚ùå</span>
                            <span id="req-letter-text"></span>
                        </div>
                        <div class="password-requirement" id="req-number">
                            <span class="icon">‚ùå</span>
                            <span id="req-number-text"></span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="register-password-confirm" id="register-password-confirm-label"></label>
                    <div class="password-input-container">
                        <input type="password" id="register-password-confirm" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('register-password-confirm')">üëÅ</button>
                    </div>
                </div>
                <button type="submit" class="auth-button" id="register-button"></button>
                <div id="register-message"></div>
                
                <!-- Google Register Section -->
                <div class="oauth-divider">
                    <span id="oauth-divider-text-register"></span>
                </div>
                <div id="google-register-button"></div>
            </form>
        </div>
    </div>

    <!-- Google Ë®ªÂÜäÂÆåÊàêË®≠ÂÆöÈ†ÅÈù¢ -->
    <div id="google-profile-setup" class="page-content hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 1000; overflow-y: auto;">
        <div class="container">
        <div class="auth-container">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 id="complete-profile-title"></h2>
                <p id="complete-profile-subtitle" style="color: #6c757d; margin: 10px 0;"></p>
            </div>
            
            <form id="google-profile-form">
                <div class="form-group">
                    <label for="google-nickname" id="google-nickname-label"></label>
                    <input type="text" id="google-nickname" placeholder="" maxlength="100">
                </div>
                
                <div class="form-group">
                    <label for="google-birth-date" id="google-birth-date-label"></label>
                    <input type="date" id="google-birth-date">
                </div>
                
                <div class="form-group">
                    <label for="google-language" id="google-language-label"></label>
                    <select id="google-language" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; box-sizing: border-box;">
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="auth-button" id="skip-setup-btn" onclick="skipGoogleSetup()" style="background: #6c757d; flex: 1;"></button>
                    <button type="submit" class="auth-button" id="save-profile-btn" style="flex: 2;"></button>
                </div>
                
                <div id="google-profile-message"></div>
            </form>
        </div>
        </div>
    </div>

    <!-- ‰∏ªÊáâÁî®ÁïåÈù¢ -->
    <div id="main-app" class="container">
        <!-- Áî®Êà∂Ë≥áË®äÂíåÁôªÂÖ•ÊåâÈàïÂçÄÂüü -->
        <div class="user-info" id="user-info" style="display: none;">
            <div class="user-avatar" id="user-avatar">U</div>
            <div class="user-details">
                <p class="user-name" id="user-name"></p>
                <p class="user-email" id="user-email">user@example.com</p>
            </div>
            <button class="logout-btn" id="logout-btn"></button>
        </div>
        
        <!-- Êú™ÁôªÂÖ•Áî®Êà∂ÁöÑÁôªÂÖ•ÊåâÈàïÂçÄÂüü -->
        <div class="guest-info" id="guest-info">
            <div style="display: flex; align-items: center; gap: 15px; padding: 10px 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffc107;">
                <div style="font-size: 20px;">‚ö†Ô∏è</div>
                <div style="flex: 1; text-align: left;">
                    <p style="margin: 0; font-weight: 500; color: #856404;" id="guest-mode-title"></p>
                    <p style="margin: 0; font-size: 12px; color: #856404;" id="guest-warning-text"></p>
                </div>
                <button class="auth-btn" id="login-signup-btn" onclick="showAuthScreen()"></button>
            </div>
        </div>

        <h1 id="title"></h1>
        <p style="margin: -10px 0 20px 0; color: #666; font-size: 14px;" id="main-author">Author: Ingee</p>

        <!-- Language selection -->
        <div style="margin-bottom: 20px;">
            <label for="language" id="language-label">üåê Language:</label>
            <select id="language">
                <option value="zh">‰∏≠Êñá</option>
                <option value="en">English</option>
            </select>
        </div>

        <!-- Navigation tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="practice">
                <span id="nav-practice"></span>
            </div>
            <div class="nav-tab" data-tab="chart">
                <span id="nav-chart"></span>
            </div>
            <div class="nav-tab" data-tab="statistics" id="statistics-nav-tab" style="display: none;">
                <span id="nav-statistics"></span>
            </div>
        </div>

        <!-- Practice mode tab content -->
        <div id="practice-tab" class="tab-content active">
            <!-- Kana type selection -->
            <div class="mode-select">
                <label>
                    <input type="radio" name="kana-type" value="hiragana" checked>
                    <span id="type-hiragana"></span>
                </label>
                <label>
                    <input type="radio" name="kana-type" value="katakana">
                    <span id="type-katakana"></span>
                </label>
                <label>
                    <input type="radio" name="kana-type" value="mixed">
                    <span id="type-mixed"></span>
                </label>
            </div>

            <!-- Practice range selection -->
            <div class="checkbox-grid">
                <div class="checkbox-group">
                    <h4 id="group-basic"></h4>
                    <label><input type="checkbox" name="category" value="basic" checked> <span id="cat-basic"></span></label>
                </div>
                <div class="checkbox-group">
                    <h4 id="group-dakuten"></h4>
                    <label><input type="checkbox" name="category" value="dakuten"> <span id="cat-dakuten"></span></label>
                </div>
                <div class="checkbox-group">
                    <h4 id="group-handakuten"></h4>
                    <label><input type="checkbox" name="category" value="handakuten"> <span id="cat-handakuten"></span></label>
                </div>
                <div class="checkbox-group">
                    <h4 id="group-youon"></h4>
                    <label><input type="checkbox" name="category" value="youon"> <span id="cat-youon"></span></label>
                </div>
            </div>

            <button id="start-btn"></button>

            <!-- Quiz area -->
            <div id="quiz-area" style="display: none;">
                <!-- Progress bar -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progress"></div>
                </div>
                
                <!-- Statistics info -->
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="current-num">1</div>
                        <div class="stat-label" id="stat-current"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-num">0</div>
                        <div class="stat-label" id="stat-total"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="score-num">0</div>
                        <div class="stat-label" id="stat-score"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="accuracy">0%</div>
                        <div class="stat-label" id="stat-accuracy"></div>
                    </div>
                </div>

                <!-- Quiz section -->
                <div class="quiz-container">
                    <div class="kana" id="kana"></div>
                    <input id="answer" placeholder="">
                    <button id="submit-btn"></button>
                    <div class="result" id="feedback"></div>
                    <img src="kabo-seed.gif" alt="Kabo Seed GIF" style="width:300px; height:auto; margin-top: 20px;">
                </div>
            </div>
        </div>

        <!-- Kana chart tab content -->
        <div id="chart-tab" class="tab-content">
            <div class="mode-select">
                <label>
                    <input type="radio" name="chart-type" value="hiragana" checked>
                    <span id="chart-hiragana-label"></span>
                </label>
                <label>
                    <input type="radio" name="chart-type" value="katakana">
                    <span id="chart-katakana-label"></span>
                </label>
            </div>
            <div id="kana-chart"></div>
            
            <!-- Concept display area -->
            <div style="margin: 30px 0;">
                <div class="checkbox-grid" style="pointer-events: none;">
                    <div class="checkbox-group" style="background: #f0f4ff; border: 2px solid #667eea;">
                        <h4 id="group-sokuon"></h4>
                        <p style="font-size: 14px; color: #666; margin: 5px 0; text-align: left;">
                            <span id="sokuon-desc"></span><br>
                            <span id="sokuon-example"></span>
                        </p>
                    </div>
                    <div class="checkbox-group" style="background: #f0f4ff; border: 2px solid #667eea;">
                        <h4 id="group-chouon"></h4>
                        <p style="font-size: 14px; color: #666; margin: 5px 0; text-align: left;">
                            <span id="chouon-desc"></span><br>
                            <span id="chouon-example"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Learning statistics tab content -->
        <div id="statistics-tab" class="tab-content">
            <div id="statistics-loading" style="text-align: center; padding: 40px; color: #666;">
                Loading...
            </div>
            
            <div id="statistics-content" style="display: none;">
                <!-- Overall statistics -->
                <div class="stats" id="overall-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="total-sessions-num">0</div>
                        <div class="stat-label" id="total-sessions-label"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-questions-num">0</div>
                        <div class="stat-label" id="total-questions-label"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-correct-num">0</div>
                        <div class="stat-label" id="total-correct-label"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="avg-accuracy-num">0%</div>
                        <div class="stat-label" id="avg-accuracy-label"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-time-num">0</div>
                        <div class="stat-label" id="total-time-label"></div>
                    </div>
                </div>
                
                <!-- Recent practice sessions -->
                <div style="margin-top: 30px;">
                    <h3 id="recent-sessions-title"></h3>
                    <div id="recent-sessions-list"></div>
                </div>
                
                <!-- Category statistics -->
                <div style="margin-top: 30px;">
                    <h3 id="category-stats-title"></h3>
                    <div id="category-stats-list"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Practice session details modal -->
    <div id="session-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSessionDetail()">&times;</span>
            <h3 id="session-detail-title"></h3>
            <div id="session-detail-content">
                <div id="session-detail-loading">Loading...</div>
            </div>
        </div>
    </div>

    <script>
    // Complete kana data
    const kanaData = {
        basic: {
            hiragana: [
                ["„ÅÇ","a"],["„ÅÑ","i"],["„ÅÜ","u"],["„Åà","e"],["„Åä","o"],
                ["„Åã","ka"],["„Åç","ki"],["„Åè","ku"],["„Åë","ke"],["„Åì","ko"],
                ["„Åï","sa"],["„Åó","shi"],["„Åô","su"],["„Åõ","se"],["„Åù","so"],
                ["„Åü","ta"],["„Å°","chi"],["„Å§","tsu"],["„Å¶","te"],["„Å®","to"],
                ["„Å™","na"],["„Å´","ni"],["„Å¨","nu"],["„Å≠","ne"],["„ÅÆ","no"],
                ["„ÅØ","ha"],["„Å≤","hi"],["„Åµ","fu"],["„Å∏","he"],["„Åª","ho"],
                ["„Åæ","ma"],["„Åø","mi"],["„ÇÄ","mu"],["„ÇÅ","me"],["„ÇÇ","mo"],
                ["„ÇÑ","ya"],["„ÇÜ","yu"],["„Çà","yo"],
                ["„Çâ","ra"],["„Çä","ri"],["„Çã","ru"],["„Çå","re"],["„Çç","ro"],
                ["„Çè","wa"],["„Çí","wo"],["„Çì","n"]
            ],
            katakana: [
                ["„Ç¢","a"],["„Ç§","i"],["„Ç¶","u"],["„Ç®","e"],["„Ç™","o"],
                ["„Ç´","ka"],["„Ç≠","ki"],["„ÇØ","ku"],["„Ç±","ke"],["„Ç≥","ko"],
                ["„Çµ","sa"],["„Ç∑","shi"],["„Çπ","su"],["„Çª","se"],["„ÇΩ","so"],
                ["„Çø","ta"],["„ÉÅ","chi"],["„ÉÑ","tsu"],["„ÉÜ","te"],["„Éà","to"],
                ["„Éä","na"],["„Éã","ni"],["„Éå","nu"],["„Éç","ne"],["„Éé","no"],
                ["„Éè","ha"],["„Éí","hi"],["„Éï","fu"],["„Éò","he"],["„Éõ","ho"],
                ["„Éû","ma"],["„Éü","mi"],["„É†","mu"],["„É°","me"],["„É¢","mo"],
                ["„É§","ya"],["„É¶","yu"],["„É®","yo"],
                ["„É©","ra"],["„É™","ri"],["„É´","ru"],["„É¨","re"],["„É≠","ro"],
                ["„ÉØ","wa"],["„É≤","wo"],["„É≥","n"]
            ]
        },
        dakuten: {
            hiragana: [
                ["„Åå","ga"],["„Åé","gi"],["„Åê","gu"],["„Åí","ge"],["„Åî","go"],
                ["„Åñ","za"],["„Åò","ji/zi"],["„Åö","zu"],["„Åú","ze"],["„Åû","zo"],
                ["„Å†","da"],["„Å¢","di/ji"],["„Å•","du/zu"],["„Åß","de"],["„Å©","do"],
                ["„Å∞","ba"],["„Å≥","bi"],["„Å∂","bu"],["„Åπ","be"],["„Åº","bo"]
            ],
            katakana: [
                ["„Ç¨","ga"],["„ÇÆ","gi"],["„Ç∞","gu"],["„Ç≤","ge"],["„Ç¥","go"],
                ["„Ç∂","za"],["„Ç∏","ji/zi"],["„Ç∫","zu"],["„Çº","ze"],["„Çæ","zo"],
                ["„ÉÄ","da"],["„ÉÇ","di/ji"],["„ÉÖ","du/zu"],["„Éá","de"],["„Éâ","do"],
                ["„Éê","ba"],["„Éì","bi"],["„Éñ","bu"],["„Éô","be"],["„Éú","bo"]
            ]
        },
        handakuten: {
            hiragana: [
                ["„Å±","pa"],["„Å¥","pi"],["„Å∑","pu"],["„Å∫","pe"],["„ÅΩ","po"]
            ],
            katakana: [
                ["„Éë","pa"],["„Éî","pi"],["„Éó","pu"],["„Éö","pe"],["„Éù","po"]
            ]
        },
        youon: {
            hiragana: [
                ["„Åç„ÇÉ","kya"],["„Åç„ÇÖ","kyu"],["„Åç„Çá","kyo"],
                ["„Åó„ÇÉ","sha"],["„Åó„ÇÖ","shu"],["„Åó„Çá","sho"],
                ["„Å°„ÇÉ","cha"],["„Å°„ÇÖ","chu"],["„Å°„Çá","cho"],
                ["„Å´„ÇÉ","nya"],["„Å´„ÇÖ","nyu"],["„Å´„Çá","nyo"],
                ["„Å≤„ÇÉ","hya"],["„Å≤„ÇÖ","hyu"],["„Å≤„Çá","hyo"],
                ["„Åø„ÇÉ","mya"],["„Åø„ÇÖ","myu"],["„Åø„Çá","myo"],
                ["„Çä„ÇÉ","rya"],["„Çä„ÇÖ","ryu"],["„Çä„Çá","ryo"],
                ["„Åé„ÇÉ","gya"],["„Åé„ÇÖ","gyu"],["„Åé„Çá","gyo"],
                ["„Åò„ÇÉ","ja"],["„Åò„ÇÖ","ju"],["„Åò„Çá","jo"],
                ["„Å¢„ÇÉ","dya"],["„Å¢„ÇÖ","dyu"],["„Å¢„Çá","dyo"],
                ["„Å≥„ÇÉ","bya"],["„Å≥„ÇÖ","byu"],["„Å≥„Çá","byo"],
                ["„Å¥„ÇÉ","pya"],["„Å¥„ÇÖ","pyu"],["„Å¥„Çá","pyo"]
            ],
            katakana: [
                ["„Ç≠„É£","kya"],["„Ç≠„É•","kyu"],["„Ç≠„Éß","kyo"],
                ["„Ç∑„É£","sha"],["„Ç∑„É•","shu"],["„Ç∑„Éß","sho"],
                ["„ÉÅ„É£","cha"],["„ÉÅ„É•","chu"],["„ÉÅ„Éß","cho"],
                ["„Éã„É£","nya"],["„Éã„É•","nyu"],["„Éã„Éß","nyo"],
                ["„Éí„É£","hya"],["„Éí„É•","hyu"],["„Éí„Éß","hyo"],
                ["„Éü„É£","mya"],["„Éü„É•","myu"],["„Éü„Éß","myo"],
                ["„É™„É£","rya"],["„É™„É•","ryu"],["„É™„Éß","ryo"],
                ["„ÇÆ„É£","gya"],["„ÇÆ„É•","gyu"],["„ÇÆ„Éß","gyo"],
                ["„Ç∏„É£","ja"],["„Ç∏„É•","ju"],["„Ç∏„Éß","jo"],
                ["„ÉÇ„É£","dya"],["„ÉÇ„É•","dyu"],["„ÉÇ„Éß","dyo"],
                ["„Éì„É£","bya"],["„Éì„É•","byu"],["„Éì„Éß","byo"],
                ["„Éî„É£","pya"],["„Éî„É•","pyu"],["„Éî„Éß","pyo"]
            ]
        }
    };

    // Kana chart data
    const chartData = {
        basic: [
            ["","a","i","u","e","o"],
            ["","„ÅÇ/„Ç¢","„ÅÑ/„Ç§","„ÅÜ/„Ç¶","„Åà/„Ç®","„Åä/„Ç™"],
            ["k","„Åã/„Ç´","„Åç/„Ç≠","„Åè/„ÇØ","„Åë/„Ç±","„Åì/„Ç≥"],
            ["s","„Åï/„Çµ","„Åó/„Ç∑","„Åô/„Çπ","„Åõ/„Çª","„Åù/„ÇΩ"],
            ["t","„Åü/„Çø","„Å°/„ÉÅ","„Å§/„ÉÑ","„Å¶/„ÉÜ","„Å®/„Éà"],
            ["n","„Å™/„Éä","„Å´/„Éã","„Å¨/„Éå","„Å≠/„Éç","„ÅÆ/„Éé"],
            ["h","„ÅØ/„Éè","„Å≤/„Éí","„Åµ/„Éï","„Å∏/„Éò","„Åª/„Éõ"],
            ["m","„Åæ/„Éû","„Åø/„Éü","„ÇÄ/„É†","„ÇÅ/„É°","„ÇÇ/„É¢"],
            ["y","„ÇÑ/„É§","","„ÇÜ/„É¶","","„Çà/„É®"],
            ["r","„Çâ/„É©","„Çä/„É™","„Çã/„É´","„Çå/„É¨","„Çç/„É≠"],
            ["w","„Çè/„ÉØ","","","","„Çí/„É≤ (wo/o)"],
            ["","","","","","„Çì/„É≥"]
        ],
        dakuten: [
            ["","a","i","u","e","o"],
            ["g","„Åå/„Ç¨","„Åé/„ÇÆ","„Åê/„Ç∞","„Åí/„Ç≤","„Åî/„Ç¥"],
            ["z","„Åñ/„Ç∂","„Åò/„Ç∏ (ji/zi)","„Åö/„Ç∫","„Åú/„Çº","„Åû/„Çæ"],
            ["d","„Å†/„ÉÄ","„Å¢/„ÉÇ (di/ji)","„Å•/„ÉÖ (du/zu)","„Åß/„Éá","„Å©/„Éâ"],
            ["b","„Å∞/„Éê","„Å≥/„Éì","„Å∂/„Éñ","„Åπ/„Éô","„Åº/„Éú"]
        ],
        handakuten: [
            ["","a","i","u","e","o"],
            ["p","„Å±/„Éë","„Å¥/„Éî","„Å∑/„Éó","„Å∫/„Éö","„ÅΩ/„Éù"]
        ]
    };

    let selected = [], current = 0, score = 0, total = 0, lang = "zh";
    let questionStartTime = null; // Record start time for each question
    
    // Translation object moved to i18next (js/i18n.js)
    
    function translateType(type, language = getCurrentLanguage()) {
        // Use i18next translation system
        if (window.i18next && window.i18next.exists) {
            // First try to find in kana.categories
            if (i18next.exists(`kana.categories.${type}`)) {
                return t(`kana.categories.${type}`);
            }
            // Then try to find in kana.groups
            if (i18next.exists(`kana.groups.${type}`)) {
                return t(`kana.groups.${type}`);
            }
            // Try to find in kana.types
            if (i18next.exists(`kana.types.${type}`)) {
                return t(`kana.types.${type}`);
            }
        }
        // Finally return original value
        return type;
    }

    // Old translation object replaced by i18next (js/i18n.js)

    // Authentication page language switching function
    function setLanguageAndUpdateAuth() {
        const authLang = document.getElementById('auth-language').value;
        document.getElementById('language').value = authLang;
        setLanguage();
    }
    
    // Registration language preference switching function
    function onLanguagePreferenceChange() {
        const preferredLang = document.getElementById('register-language').value;
        document.getElementById('language').value = preferredLang;
        setLanguage();
    }
    
    // Initialize language settings (based on system language)
    function initializeLanguage() {
        let detectedLang = 'zh'; // Default Traditional Chinese
        
        // Try to get saved language preference from localStorage
        const savedLang = localStorage.getItem('preferredLanguage');
        if (savedLang && ['zh', 'en'].includes(savedLang)) {
            detectedLang = savedLang;
        } else {
            // Detect browser language settings
            const browserLang = navigator.language || navigator.userLanguage;
            console.log('Browser language detected:', browserLang);
            
            // Check if Chinese (including Traditional and Simplified)
            if (browserLang.startsWith('zh')) {
                detectedLang = 'zh';
            } else {
                detectedLang = 'en';
            }
        }
        
        // Set all language selectors
        const languageSelect = document.getElementById('language');
        const authLanguageSelect = document.getElementById('auth-language');
        const registerLanguageSelect = document.getElementById('register-language');
        
        if (languageSelect) languageSelect.value = detectedLang;
        if (authLanguageSelect) authLanguageSelect.value = detectedLang;
        if (registerLanguageSelect) registerLanguageSelect.value = detectedLang;
        
        // Save language preference
        localStorage.setItem('preferredLanguage', detectedLang);
        
        // Set global language
        lang = detectedLang;
        console.log('Language initialized to:', detectedLang);
    }

    // ÂêåÊ≠•ÊâÄÊúâË™ûË®ÄÈÅ∏ÊìáÂô®
    function syncAllLanguageSelectors() {
        const currentLang = getCurrentLanguage();
        console.log("Syncing all language selectors to:", currentLang);
        
        // ÂêåÊ≠•‰∏ªË™ûË®ÄÈÅ∏ÊìáÂô®
        const mainLanguageSelect = document.getElementById('language');
        if (mainLanguageSelect && mainLanguageSelect.value !== currentLang) {
            mainLanguageSelect.value = currentLang;
        }
        
        // ÂêåÊ≠•Ë™çË≠âÈ†ÅÈù¢Ë™ûË®ÄÈÅ∏ÊìáÂô®
        const authLanguageSelect = document.getElementById('auth-language');
        if (authLanguageSelect && authLanguageSelect.value !== currentLang) {
            authLanguageSelect.value = currentLang;
        }
        
        // ÂêåÊ≠•Ë®ªÂÜäÈ†ÅÈù¢Ë™ûË®ÄÈÅ∏ÊìáÂô®
        const registerLanguageSelect = document.getElementById('register-language');
        if (registerLanguageSelect && registerLanguageSelect.value !== currentLang) {
            registerLanguageSelect.value = currentLang;
        }
        
        // ÂêåÊ≠•Á∑¥ÁøíÊ®°ÂºèË™ûË®ÄÈÅ∏ÊìáÂô®
        const practiceLanguageSelect = document.getElementById('practice-language');
        if (practiceLanguageSelect && practiceLanguageSelect.value !== currentLang) {
            practiceLanguageSelect.value = currentLang;
        }
        
        // ÂêåÊ≠•ÈåØÈ°åË§áÁøíÊ®°ÂºèË™ûË®ÄÈÅ∏ÊìáÂô®
        const reviewLanguageSelect = document.getElementById('review-language');
        if (reviewLanguageSelect && reviewLanguageSelect.value !== currentLang) {
            reviewLanguageSelect.value = currentLang;
        }
        
        console.log("All language selectors synced");
    }

    async function setLanguage() {
        console.log("setLanguage called");
        
        // Get language from main language selector
        const languageSelect = document.getElementById("language") || document.getElementById("language-select");
        if (languageSelect) {
            await changeLanguage(languageSelect.value);
        }
        
        console.log("Language set to:", getCurrentLanguage());
        syncAllLanguageSelectors();
        
        try {
            console.log("Language updated successfully");
            updateChart();
            
            // If currently on learning statistics page, reload statistics data to apply new language
            const statisticsTab = document.getElementById('statistics-tab');
            const activeNavTab = document.querySelector('.nav-tab[data-tab="statistics"].active');
            if ((statisticsTab && statisticsTab.style.display !== 'none' && statisticsTab.classList.contains('active')) || activeNavTab) {
                console.log("Reloading statistics for language change");
                setTimeout(() => loadStatistics(), 100);
            }
        } catch (error) {
            console.error("Error in setLanguage:", error);
        }
    }

    function showTab(tabName) {
        console.log("showTab called with:", tabName);
        
        // First hide all tab-content
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
            tab.style.display = 'none';
        });
        // First remove active from all nav-tabs
        document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

        // Show corresponding tab
        const currentTab = document.getElementById(tabName + '-tab');
        if (currentTab) {
            currentTab.classList.add('active');
            currentTab.style.display = 'block';
            console.log("Tab displayed:", tabName);
        } else {
            console.log("Tab not found:", tabName + '-tab');
        }
        
        // Add active to corresponding nav-tab
        const activeNavTab = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
        if (activeNavTab) {
            activeNavTab.classList.add('active');
            console.log("Nav tab activated:", tabName);
        }

        // Control start practice button display
        const startBtn = document.getElementById("start-btn");
        if (startBtn) {
            if (tabName === 'practice') {
                startBtn.style.display = "";
                startBtn.innerText = t('practice.startBtn');
                console.log("Start button shown");
            } else {
                startBtn.style.display = "none";
                console.log("Start button hidden");
            }
        }

        // Á¢∫‰øùË™ûË®ÄË®≠ÂÆöÊ≠£Á¢∫ÊáâÁî®Âà∞Áï∂ÂâçÊ®ôÁ±§È†Å
        if (window.updateAllTexts) {
            updateAllTexts();
        }
        
        if (tabName === 'chart') {
            updateChart();
            console.log("Chart updated");
        } else if (tabName === 'statistics') {
            if (currentUser && authToken) {
                loadStatistics();
                console.log("Statistics loaded");
            } else {
                const loadingEl = document.getElementById('statistics-loading');
                if (loadingEl) {
                    loadingEl.textContent = t('stats.loginRequired');
                }
            }
        }
    }

    function updateKanaType() {
        // Logic can be added when kana type is updated
    }

    function shuffle(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    function startQuiz() {
        console.log("startQuiz called");
        
        try {
            // Clean up previous practice state
            const existingQuizArea = document.getElementById("quiz-area");
            if (existingQuizArea) {
                existingQuizArea.style.display = "none";
            }
            const inlineQuiz = document.getElementById("inline-quiz");
            if (inlineQuiz) {
                inlineQuiz.remove();
            }
            const existingQuizHeader = document.getElementById("quiz-header");
            if (existingQuizHeader) {
                existingQuizHeader.remove();
            }
            
            const kanaTypeEl = document.querySelector('input[name="kana-type"]:checked');
            if (!kanaTypeEl) {
                console.log("No kana type selected");
                return;
            }
            
            const kanaType = kanaTypeEl.value;
            // Security improvement: validate kanaType value
            if (!['hiragana', 'katakana', 'mixed'].includes(kanaType)) {
                console.error("Invalid kana type:", kanaType);
                return;
            }
            
            const categories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(cb => cb.value);
            
            if (categories.length === 0) {
                alert(t('practice.selectTypeAlert'));
                return;
            }

            let kanaList = [];
            categories.forEach(category => {
                // Security improvement: validate category value
                if (kanaData[category] && ['basic', 'dakuten', 'handakuten', 'youon'].includes(category)) {
                    if (kanaType === 'mixed') {
                        if (kanaData[category].hiragana) kanaList.push(...kanaData[category].hiragana);
                        if (kanaData[category].katakana) kanaList.push(...kanaData[category].katakana);
                    } else {
                        if (kanaData[category][kanaType]) kanaList.push(...kanaData[category][kanaType]);
                    }
                }
            });

            if (kanaList.length === 0) {
                console.log("No kana data found");
                return;
            }

            selected = shuffle(kanaList);
            current = 0;
            score = 0;
            total = selected.length;
            
            // Start practice session record for logged-in users
            if (currentUser) {
                startPracticeSession(kanaType, categories);
            }
            
            // Enter practice mode - hide main menu content, show practice content
            const practiceTab = document.getElementById("practice-tab");
            const chartTab = document.getElementById("chart-tab");
            const navTabs = document.querySelector(".nav-tabs");
            const languageSelect = document.querySelector('div[style*="margin-bottom: 20px"]');
            
            console.log("Hiding menu elements...");
            
            if (practiceTab) {
                // Hide options area
                const checkboxGrid = practiceTab.querySelector(".checkbox-grid");
                const modeSelect = practiceTab.querySelector(".mode-select");
                const startBtn = document.getElementById("start-btn");
                
                if (checkboxGrid) {
                    checkboxGrid.style.display = "none";
                    console.log("Checkbox grid hidden");
                }
                if (modeSelect) {
                    modeSelect.style.display = "none";
                    console.log("Mode select hidden");
                }
                if (startBtn) {
                    startBtn.style.display = "none";
                    console.log("Start button hidden");
                }
                if (navTabs) {
                    navTabs.style.display = "none";
                    console.log("Nav tabs hidden");
                }
                if (chartTab) {
                    chartTab.style.display = "none";
                    console.log("Chart tab hidden");
                }
                if (languageSelect) {
                    languageSelect.style.display = "none";
                    console.log("Language select hidden");
                }
                
                // Create practice page top navigation
                let quizHeader = document.createElement("div");
                quizHeader.id = "quiz-header";
                quizHeader.style.cssText = "display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 15px; background: rgba(255,255,255,0.9); border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);";
                
                const backButton = document.createElement("button");
                backButton.innerHTML = "‚Üê " + t('practice.backBtn');
                backButton.style.cssText = "background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;";
                backButton.onclick = returnToMenu;
                
                const title = document.createElement("h2");
                title.style.cssText = "margin: 0; color: #2c3e50;";
                title.innerText = t('practice.title');
                
                // Add language selector to practice mode header
                const languageContainer = document.createElement("div");
                languageContainer.style.cssText = "display: flex; align-items: center; gap: 8px;";
                
                const langLabel = document.createElement("label");
                langLabel.textContent = "üåê";
                langLabel.style.cssText = "font-size: 14px; color: #666;";
                
                const langSelect = document.createElement("select");
                langSelect.id = "practice-language";
                langSelect.style.cssText = "padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;";
                
                // Add language options
                const zhOption = document.createElement("option");
                zhOption.value = "zh";
                zhOption.textContent = getCurrentLanguage() === 'en' ? 'Chinese' : '‰∏≠Êñá';
                const enOption = document.createElement("option");
                enOption.value = "en";
                enOption.textContent = "English";
                
                langSelect.appendChild(zhOption);
                langSelect.appendChild(enOption);
                langSelect.value = getCurrentLanguage();
                
                // Add event listener for language change
                langSelect.addEventListener('change', async function() {
                    await changeLanguage(this.value);
                    syncAllLanguageSelectors();
                });
                
                languageContainer.appendChild(langLabel);
                languageContainer.appendChild(langSelect);
                
                quizHeader.appendChild(backButton);
                quizHeader.appendChild(title);
                quizHeader.appendChild(languageContainer);
                
                practiceTab.insertBefore(quizHeader, practiceTab.firstChild);
                console.log("Quiz header created");
            }
            
            // Force display quiz content
            console.log("Force showing quiz content...");
            
            // Directly display quiz area here
            const quizArea = document.getElementById("quiz-area");
            console.log("Direct quiz area check:", quizArea);
            
            if (quizArea) {
                quizArea.style.display = "block";
                quizArea.style.visibility = "visible";
                quizArea.style.opacity = "1";
                quizArea.style.position = "relative";
                quizArea.style.zIndex = "1000";
                quizArea.style.backgroundColor = "rgba(255,255,255,0.95)";
                quizArea.style.padding = "20px";
                quizArea.style.borderRadius = "10px";
                quizArea.style.marginTop = "20px";
                console.log("Quiz area shown directly with enhanced styles");
            } else {
                console.log("Quiz area NOT found - creating inline");
                // Directly create quiz content - use secure DOM API
                const practiceTab = document.getElementById("practice-tab");
                if (practiceTab) {
                    const inlineQuiz = document.createElement("div");
                    inlineQuiz.id = "inline-quiz";
                    
                    // ‰ΩøÁî®ÂÆâÂÖ®ÁöÑ DOM API ËÄå‰∏çÊòØ innerHTML
                    const kanaDiv = document.createElement("div");
                    kanaDiv.id = "kana";
                    kanaDiv.style.cssText = "font-size: 72px; margin: 20px; color: #2c3e50; text-align: center;";
                    
                    const containerDiv = document.createElement("div");
                    containerDiv.style.cssText = "text-align: center; margin: 20px;";
                    
                    const answerInput = document.createElement("input");
                    answerInput.id = "answer";
                    answerInput.placeholder = t('practice.enterRomaji');
                    answerInput.style.cssText = "padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; margin: 5px;";
                    // ‰∏çË¶ÅÂú®ÈÄôË£°Âä†‰∫ã‰ª∂Áõ£ËÅΩ
                    
                    const submitBtn = document.createElement("button");
                    submitBtn.id = "submit-btn";
                    submitBtn.textContent = t('practice.submitAnswer');
                    submitBtn.style.cssText = "padding: 12px 24px; font-size: 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;";
                    // ‰∏çË¶ÅÂú®ÈÄôË£°Âä†‰∫ã‰ª∂Áõ£ËÅΩ
                    
                    const feedbackDiv = document.createElement("div");
                    feedbackDiv.id = "feedback";
                    feedbackDiv.style.cssText = "font-size: 18px; margin: 20px; font-weight: 500;";
                    
                    const img = document.createElement("img");
                    img.src = "kabo-seed.gif";
                    img.alt = "Kabo Seed GIF";
                    img.style.cssText = "width:300px; height:auto; margin-top: 20px;";
                    
                    // ÁµÑË£ù DOM ÁµêÊßã
                    containerDiv.appendChild(answerInput);
                    containerDiv.appendChild(document.createElement("br"));
                    containerDiv.appendChild(document.createElement("br"));
                    containerDiv.appendChild(submitBtn);
                    containerDiv.appendChild(feedbackDiv);
                    containerDiv.appendChild(img);
                    
                    inlineQuiz.appendChild(kanaDiv);
                    inlineQuiz.appendChild(containerDiv);
                    
                    practiceTab.appendChild(inlineQuiz);
                    console.log("Inline quiz created using safe DOM API");
                    
                    // ÈáçÊñ∞Ë®≠ÁΩÆ‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºàÂõ†ÁÇ∫Êñ∞ÂâµÂª∫ÁöÑÂÖÉÁ¥†Ôºâ
                    setupQuizEventListeners();
                }
            }
            
            const totalNumEl = document.getElementById("total-num");
            if (totalNumEl) {
                totalNumEl.innerText = total;
                console.log("Total number set to:", total);
            }
            
            console.log("Calling updateStats...");
            updateStats();
            console.log("Calling nextQuestion...");
            nextQuestion();
            console.log("Quiz started successfully");
            showQuizContent();
        } catch (error) {
            console.error("Error in startQuiz:", error);
            alert(t('common.error'));
        }
    }

    function showQuizContent() {
        // Ensure all practice-related elements are displayed
        const elementsToShow = [
            "progress", "current-num", "total-num", "score-num", "accuracy",
            "stat-current", "stat-total", "stat-score", "stat-accuracy",
            "kana", "answer", "submit-btn", "feedback"
        ];
        
        elementsToShow.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = "";
            }
        });
        
        // Á¢∫‰øùÈÄ≤Â∫¶Ê¢ùÂÆπÂô®È°ØÁ§∫
        const progressBar = document.querySelector(".progress-bar");
        if (progressBar) progressBar.style.display = "block";
        
        // Á¢∫‰øùÁµ±Ë®àÂçÄÂüüÈ°ØÁ§∫
        const stats = document.querySelector(".stats");
        if (stats) stats.style.display = "flex";
        
        // Á¢∫‰øùÊ∏¨È©óÂÆπÂô®È°ØÁ§∫
        const quizContainer = document.querySelector(".quiz-container");
        if (quizContainer) quizContainer.style.display = "flex";
        
        // Á¢∫‰øùÂíñÊ≥¢Á®ÆÂ≠êÈ°ØÁ§∫
        const kaboImg = document.querySelector('img[alt="Kabo Seed GIF"]');
        if (kaboImg) {
            kaboImg.style.display = "block";
        }
    }

    function returnToMenu() {
        console.log("Returning to menu...");
        
        // Return to main menu - show main menu content, hide practice content
        const practiceTab = document.getElementById("practice-tab");
        const chartTab = document.getElementById("chart-tab");
        const navTabs = document.querySelector(".nav-tabs");
        const languageSelect = document.querySelector('div[style*="margin-bottom: 20px"]');
        const quizHeader = document.getElementById("quiz-header");
        
        if (practiceTab) {
            // È°ØÁ§∫ÈÅ∏È†ÖÂçÄÂüü
            const checkboxGrid = practiceTab.querySelector(".checkbox-grid");
            const modeSelect = practiceTab.querySelector(".mode-select");
            const startBtn = document.getElementById("start-btn");
            
            if (checkboxGrid) {
                checkboxGrid.style.display = "";
                console.log("Checkbox grid restored");
            }
            if (modeSelect) {
                modeSelect.style.display = "";
                console.log("Mode select restored");
            }
            if (startBtn) {
                startBtn.style.display = "";
                console.log("Start button restored");
            }
            if (navTabs) {
                navTabs.style.display = "";
                console.log("Nav tabs restored");
            }
            if (languageSelect) {
                languageSelect.style.display = "";
                console.log("Language select restored");
            }
            if (quizHeader) {
                quizHeader.style.display = "none";
                console.log("Quiz header hidden");
            }
        }
        
        // ‰øÆÊ≠£Ôºö‰∏çË¶ÅÁõ¥Êé•Ë®≠ display: noneÔºåËÆì tab ÂàáÊèõÊôÇËá™ÂãïÁÆ°ÁêÜ
        if (chartTab) {
            chartTab.classList.remove('active');
            console.log("Chart tab reset (remove active class)");
        }
        
        // Èö±ËóèÊ∏¨È©óÂÖßÂÆπ
        hideQuizContent();
        
        console.log("Returned to main menu");
    }

    function hideQuizContent() {
        // Èö±Ëóè quiz-area
        const quizArea = document.getElementById("quiz-area");
        if (quizArea) quizArea.style.display = "none";

        // Èö±ËóèÈÄ≤Â∫¶Ê¢ùÂÆπÂô®
        const progressBar = document.querySelector(".progress-bar");
        if (progressBar) progressBar.style.display = "none";
        
        // Èö±ËóèÁµ±Ë®àÂçÄÂüü
        const stats = document.querySelector(".stats");
        if (stats) stats.style.display = "none";
        
        // Èö±ËóèÊ∏¨È©óÂÆπÂô®
        const quizContainer = document.querySelector(".quiz-container");
        if (quizContainer) quizContainer.style.display = "none";
        
        // Èö±ËóèÂÅáÂêçÈ°ØÁ§∫
        const kanaEl = document.getElementById("kana");
        if (kanaEl) kanaEl.innerText = "";
        
        // Èö±ËóèÂíñÊ≥¢Á®ÆÂ≠ê
        const kaboImg = document.querySelector('img[alt="Kabo Seed GIF"]');
        if (kaboImg) {
            kaboImg.style.display = "none";
        }
        
        // Ê∏ÖÈô§ÂèçÈ•ã
        const feedbackEl = document.getElementById("feedback");
        if (feedbackEl) feedbackEl.innerText = "";
    }

    function updateStats() {
        const currentEl = document.getElementById("current-num");
        const scoreEl = document.getElementById("score-num");
        const accuracyEl = document.getElementById("accuracy");
        const progressEl = document.getElementById("progress");
        
        if (currentEl) currentEl.innerText = current + 1;
        if (scoreEl) scoreEl.innerText = score;
        if (accuracyEl) accuracyEl.innerText = current > 0 ? Math.round(score / current * 100) + "%" : "0%";
        
        if (progressEl) {
            const progress = ((current) / total) * 100;
            progressEl.style.width = progress + "%";
        }
    }

    function nextQuestion() {
        console.log("nextQuestion called, current:", current, "total:", total);
        
        const kanaEl = document.getElementById("kana");
        const answerEl = document.getElementById("answer");
        const submitBtnEl = document.getElementById("submit-btn");
        const feedbackEl = document.getElementById("feedback");
        
        console.log("Kana element:", kanaEl);
        console.log("Answer element:", answerEl);
        
        if (current >= selected.length) {
            // ÁÇ∫ÁôªÂÖ•Áî®Êà∂ÂÆåÊàêÁ∑¥ÁøíË®òÈåÑ
            if (currentUser && currentSessionId) {
                completePracticeSession(score, total);
            }
            
            if (kanaEl) {
                let finalMessage;
                
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÈåØÈ°åË§áÁøíÊ®°Âºè
                const isReviewMode = currentSessionId === null && document.getElementById('review-language');
                
                if (isReviewMode) {
                    finalMessage = `üîÑ ${t('practice.reviewMode')} ${t('practice.practiceComplete')}ÔºÅ\n${t('common.score')}Ôºö${score} / ${total} (${Math.round(score/total*100)}%)`;
                } else {
                    finalMessage = `üåü ${t('practice.practiceComplete')}ÔºÅ${t('common.score')}Ôºö${score} / ${total} (${Math.round(score/total*100)}%)`;
                }
                
                // Â¶ÇÊûúÁî®Êà∂Êú™ÁôªÂÖ•ÔºåÊ∑ªÂä†Ë≠¶ÂëäË®äÊÅØÔºà‰ΩÜÈåØÈ°åË§áÁøíÊ®°Âºè‰∏çÈúÄË¶ÅÔºâ
                if (!currentUser && !isReviewMode) {
                    finalMessage += `\n\n‚ö†Ô∏è ${t('app.guestWarning')}\n${t('common.loginToTrack')}`;
                }
                
                kanaEl.innerText = finalMessage;
                console.log(isReviewMode ? "Review mode completed" : "Practice completed");
            }
            if (answerEl) answerEl.style.display = "none";
            if (submitBtnEl) submitBtnEl.style.display = "none";
            if (feedbackEl) feedbackEl.innerText = "";
            
            // Â¶ÇÊûúÁî®Êà∂Êú™ÁôªÂÖ•ÔºåÂú®ÂèçÈ•ãÂçÄÂüüÈ°ØÁ§∫ÁôªÂÖ•ÊèêÁ§∫
            if (!currentUser && feedbackEl) {
                feedbackEl.innerHTML = `<div style="background: rgba(255, 193, 7, 0.1); border: 1px solid #ffc107; border-radius: 6px; padding: 15px; margin-top: 20px;"><div style="color: #856404; font-weight: 500; margin-bottom: 10px;">${t('common.saveRecordsPrompt')}</div><div style="color: #856404; font-size: 14px; margin-bottom: 15px;">${t('common.registerPrompt')}</div><button onclick="showAuthScreen()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">${t('common.registerNow')}</button></div>`;
            }
            return;
        }
        
        if (kanaEl) {
            kanaEl.innerText = selected[current][0];
            questionStartTime = Date.now(); // Ë®òÈåÑÊú¨È°åÈñãÂßãÊôÇÈñì
            console.log("Current kana set to:", selected[current][0]);
        }
        if (answerEl) {
            answerEl.value = "";
            answerEl.style.display = "inline";
            setTimeout(() => answerEl.focus(), 100);
            console.log("Answer input reset and focused");
        }
        if (submitBtnEl) submitBtnEl.style.display = "inline";
        if (feedbackEl) feedbackEl.innerText = "";
        
        updateStats();
    }

    function checkAnswer() {
        const answerEl = document.getElementById("answer");
        const feedbackEl = document.getElementById("feedback");
        
        if (!answerEl || !feedbackEl) return;
        
        // ÂÆâÂÖ®ÊÄßÊîπÈÄ≤ÔºöËº∏ÂÖ•È©óË≠âËàáÊ∏ÖÁêÜ
        let user = answerEl.value.trim().toLowerCase();
        
        // Èò≤Ê≠¢ XSS ÊîªÊìäÔºöÁßªÈô§Âç±Èö™Â≠óÁ¨¶
        user = user.replace(/[<>\"'&]/g, '');
        
        // ÈôêÂà∂Ëº∏ÂÖ•Èï∑Â∫¶
        if (user.length > 50) {
            user = user.substring(0, 50);
        }
        
        // Âè™ÂÖÅË®±Â≠óÊØç„ÄÅÊï∏Â≠óÂíåÂü∫Êú¨Á¨¶Ëôü
        if (!/^[a-zA-Z0-9\s\/\-]+$/.test(user)) {
            feedbackEl.innerText = "‚ö†Ô∏è " + t('practice.enterRomaji');
            feedbackEl.style.color = "#e74c3c";
            return;
        }
        
        const char = selected[current][0];
        const correctAnswers = selected[current][1];
        const questionStartTime = Date.now(); // Ë®òÈåÑÁ≠îÈ°åÈñãÂßãÊôÇÈñì
        
        // ËôïÁêÜÂ§öÁ®ÆËÆÄÈü≥ÁöÑÊÉÖÊ≥Å
        let acceptableAnswers = [];
        if (correctAnswers.includes('/')) {
            acceptableAnswers = correctAnswers.split('/');
        } else {
            acceptableAnswers = [correctAnswers];
        }
        
        // ÁâπÊÆäÊÉÖÊ≥ÅËôïÁêÜ
        if (char === "„Çí" || char === "„É≤") {
            acceptableAnswers = ["wo", "o"];
        }
        if (char === "„Å¢" || char === "„ÉÇ") {
            acceptableAnswers = ["di", "ji"];
        }
        if (char === "„Å•" || char === "„ÉÖ") {
            acceptableAnswers = ["du", "zu"];
        }
        if (char === "„Åò" || char === "„Ç∏") {
            acceptableAnswers = ["ji", "zi"];
        }
        
        const isCorrect = acceptableAnswers.includes(user);
        
        if (isCorrect) {
            feedbackEl.innerText = t('common.correct');
            feedbackEl.style.color = "#27ae60";
            score++;
        } else {
            const answerDisplay = acceptableAnswers.length > 1 ? 
                acceptableAnswers.join(' / ') : acceptableAnswers[0];
            feedbackEl.innerText = `‚ùå ${t('common.incorrect')}, ${t('sessionDetail.correct')}: ${answerDisplay}`;
            feedbackEl.style.color = "#e74c3c";
        }
        
        // ÁÇ∫ÁôªÂÖ•Áî®Êà∂Ë®òÈåÑÁ≠îÈ°å
        if (currentUser) {
            const responseTime = questionStartTime ? Date.now() - questionStartTime : 0;
            recordAnswerWithTime(char, user, correctAnswers, isCorrect, responseTime);
        }
        
        current++;
        setTimeout(nextQuestion, 1500);
    }

    function updateChart() {
        console.log("updateChart called");
        
        const chartType = document.querySelector('input[name="chart-type"]:checked');
        if (!chartType) {
            console.log("No chart type selected, defaulting to hiragana");
            // Â¶ÇÊûúÊâæ‰∏çÂà∞ÈÅ∏‰∏≠ÁöÑÈ°ûÂûãÔºåÈªòË™çÁÇ∫Âπ≥ÂÅáÂêç
            const hiraganaRadio = document.querySelector('input[name="chart-type"][value="hiragana"]');
            if (hiraganaRadio) hiraganaRadio.checked = true;
        }
        
        const selectedType = chartType ? chartType.value : 'hiragana';
        console.log("Chart type:", selectedType);
        
        const chartContainer = document.getElementById("kana-chart");
        console.log("Chart container:", chartContainer);
        
        if (!chartContainer) {
            console.log("Chart container not found!");
            return;
        }
        
        let html = "";
        
        // Âü∫Êú¨Èü≥Ë°®
        html += `<h3>${t('kana.categories.basic')}</h3>`;
        html += createChartTable(chartData.basic, selectedType);
        
        // ÊøÅÈü≥Ë°®
        html += `<h3>${t('kana.categories.dakuten')}</h3>`;
        html += createChartTable(chartData.dakuten, selectedType);
        
        // ÂçäÊøÅÈü≥Ë°®
        html += `<h3>${t('kana.categories.handakuten')}</h3>`;
        html += createChartTable(chartData.handakuten, selectedType);
        
        // ÊãóÈü≥Ë°®
        html += `<h3>${t('kana.categories.youon')}</h3>`;
        html += createYouonTable(selectedType);
        
        console.log("Generated HTML length:", html.length);
        console.log("HTML preview:", html.substring(0, 200) + "...");
        
        // ÂÆâÂÖ®ÊÄßÊîπÈÄ≤Ôºö‰ΩøÁî® textContent ËÄå‰∏çÊòØ innerHTMLÔºàÂ¶ÇÊûúÂèØËÉΩÔºâ
        // Áî±ÊñºÈÄôË£°ÈúÄË¶Å HTML Ê†ºÂºèÔºåÊàëÂÄëÁ¢∫‰øùÂÖßÂÆπÊòØÂÆâÂÖ®ÁöÑ
        chartContainer.innerHTML = html;
        console.log("Chart container updated");
    }

    function createChartTable(data, type) {
        console.log("createChartTable called with type:", type);
        console.log("Data:", data);
        
        let html = '<table class="chart-table" style="width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
        
        data.forEach((row, index) => {
            html += '<tr>';
            row.forEach((cell, cellIndex) => {
                const cellStyle = index === 0 ? 
                    'style="padding: 12px; text-align: center; border: 1px solid #e9ecef; background: #667eea; color: white; font-weight: 600;"' :
                    'style="padding: 12px; text-align: center; border: 1px solid #e9ecef; font-size: 18px;"';
                
                if (index === 0) {
                    html += `<th ${cellStyle}>${cell}</th>`;
                } else {
                    if (cellIndex === 0) {
                        html += `<th ${cellStyle}>${cell}</th>`;
                    } else {
                        if (cell === "") {
                            html += '<td style="padding: 12px; text-align: center; border: 1px solid #e9ecef;"></td>';
                        } else {
                            // Ê™¢Êü•ÊòØÂê¶ÂåÖÂê´Êã¨ËôüÔºàÂ§öÁ®ÆËÆÄÈü≥Ôºâ
                            if (cell.includes('(')) {
                                // ÊúâÊã¨ËôüÁöÑÊÉÖÊ≥ÅÔºåÁõ¥Êé•È°ØÁ§∫
                                const kanaChars = cell.split(' (')[0].split('/');
                                const displayChar = type === 'hiragana' ? kanaChars[0] : kanaChars[1];
                                const romajiPart = cell.split(' (')[1].replace(')', '');
                                html += `<td style="padding: 12px; text-align: center; border: 1px solid #e9ecef;">
                                    <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${displayChar}</div>
                                    <div style="font-size: 14px; color: #666; font-family: monospace;">${romajiPart}</div>
                                </td>`;
                            } else {
                                // ÊôÆÈÄöÊÉÖÊ≥ÅÔºåÊü•ÊâæÁæÖÈ¶¨Â≠ó
                                const kanaChars = cell.split('/');
                                const displayChar = type === 'hiragana' ? kanaChars[0] : kanaChars[1];
                                const romaji = getRomajiForKana(displayChar);
                                html += `<td style="padding: 12px; text-align: center; border: 1px solid #e9ecef;">
                                    <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${displayChar}</div>
                                    <div style="font-size: 14px; color: #666; font-family: monospace;">${romaji}</div>
                                </td>`;
                            }
                        }
                    }
                }
            });
            html += '</tr>';
        });
        
        html += '</table>';
        console.log("Generated table HTML length:", html.length);
        return html;
    }

    function createYouonTable(type) {
        const youonGroups = [
            {name: "„Åç„ÇÉË°å", kana: ["„Åç„ÇÉ/„Ç≠„É£", "„Åç„ÇÖ/„Ç≠„É•", "„Åç„Çá/„Ç≠„Éß"], romaji: ["kya", "kyu", "kyo"]},
            {name: "„Åó„ÇÉË°å", kana: ["„Åó„ÇÉ/„Ç∑„É£", "„Åó„ÇÖ/„Ç∑„É•", "„Åó„Çá/„Ç∑„Éß"], romaji: ["sha", "shu", "sho"]},
            {name: "„Å°„ÇÉË°å", kana: ["„Å°„ÇÉ/„ÉÅ„É£", "„Å°„ÇÖ/„ÉÅ„É•", "„Å°„Çá/„ÉÅ„Éß"], romaji: ["cha", "chu", "cho"]},
            {name: "„Å´„ÇÉË°å", kana: ["„Å´„ÇÉ/„Éã„É£", "„Å´„ÇÖ/„Éã„É•", "„Å´„Çá/„Éã„Éß"], romaji: ["nya", "nyu", "nyo"]},
            {name: "„Å≤„ÇÉË°å", kana: ["„Å≤„ÇÉ/„Éí„É£", "„Å≤„ÇÖ/„Éí„É•", "„Å≤„Çá/„Éí„Éß"], romaji: ["hya", "hyu", "hyo"]},
            {name: "„Åø„ÇÉË°å", kana: ["„Åø„ÇÉ/„Éü„É£", "„Åø„ÇÖ/„Éü„É•", "„Åø„Çá/„Éü„Éß"], romaji: ["mya", "myu", "myo"]},
            {name: "„Çä„ÇÉË°å", kana: ["„Çä„ÇÉ/„É™„É£", "„Çä„ÇÖ/„É™„É•", "„Çä„Çá/„É™„Éß"], romaji: ["rya", "ryu", "ryo"]},
            {name: "„Åé„ÇÉË°å", kana: ["„Åé„ÇÉ/„ÇÆ„É£", "„Åé„ÇÖ/„ÇÆ„É•", "„Åé„Çá/„ÇÆ„Éß"], romaji: ["gya", "gyu", "gyo"]},
            {name: "„Åò„ÇÉË°å", kana: ["„Åò„ÇÉ/„Ç∏„É£", "„Åò„ÇÖ/„Ç∏„É•", "„Åò„Çá/„Ç∏„Éß"], romaji: ["ja", "ju", "jo"]},
            {name: "„Å≥„ÇÉË°å", kana: ["„Å≥„ÇÉ/„Éì„É£", "„Å≥„ÇÖ/„Éì„É•", "„Å≥„Çá/„Éì„Éß"], romaji: ["bya", "byu", "byo"]},
            {name: "„Å¥„ÇÉË°å", kana: ["„Å¥„ÇÉ/„Éî„É£", "„Å¥„ÇÖ/„Éî„É•", "„Å¥„Çá/„Éî„Éß"], romaji: ["pya", "pyu", "pyo"]}
        ];

        let html = '<table class="chart-table">';
        html += `<tr><th>${t('chart.tableRow')}</th><th>${t('chart.yaColumn')}</th><th>${t('chart.yuColumn')}</th><th>${t('chart.yoColumn')}</th></tr>`;
        
        youonGroups.forEach(group => {
            html += '<tr>';
            html += `<th>${group.name}</th>`;
            group.kana.forEach((kana, index) => {
                const kanaChars = kana.split('/');
                const displayChar = type === 'hiragana' ? kanaChars[0] : kanaChars[1];
                html += `<td>
                    <div class="kana-char">${displayChar}</div>
                    <div class="romaji">${group.romaji[index]}</div>
                </td>`;
            });
            html += '</tr>';
        });
        
        html += '</table>';
        return html;
    }

    function getRomajiForKana(kana) {
        // Êü•ÊâæÂÅáÂêçÂ∞çÊáâÁöÑÁæÖÈ¶¨Â≠ó
        for (const category in kanaData) {
            for (const type in kanaData[category]) {
                const found = kanaData[category][type].find(item => item[0] === kana);
                if (found) return found[1];
            }
        }
        return "";
    }

    // API Âü∫Á§éË®≠ÂÆö
    const API_BASE_URL = 'http://127.0.0.1:8001/api';
    let currentUser = null;
    let authToken = null;
    
    // Learning record related variables
    let currentSessionId = null;
    let sessionStartTime = null;

    // Password show/hide functionality
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const toggleButton = input.nextElementSibling;
        
        if (input.type === 'password') {
            input.type = 'text';
            toggleButton.textContent = 'üôà'; // Áå¥Â≠êÈÅÆÁúºÁöÑ emoji
        } else {
            input.type = 'password';
            toggleButton.textContent = 'üëÅ'; // ÁúºÁùõ emoji
        }
    }
    
    // Password validation functionality
    function validatePassword() {
        const password = document.getElementById('register-password').value;
        
        // Èï∑Â∫¶Ë¶ÅÊ±Ç
        const lengthReq = document.getElementById('req-length');
        const lengthMet = password.length >= 8;
        updateRequirement(lengthReq, lengthMet);
        
        // Ëã±ÊñáÂ≠óÊØçË¶ÅÊ±Ç
        const letterReq = document.getElementById('req-letter');
        const letterMet = /[a-zA-Z]/.test(password);
        updateRequirement(letterReq, letterMet);
        
        // Êï∏Â≠óË¶ÅÊ±Ç
        const numberReq = document.getElementById('req-number');
        const numberMet = /[0-9]/.test(password);
        updateRequirement(numberReq, numberMet);
        
        return lengthMet && letterMet && numberMet;
    }
    
    function updateRequirement(element, isMet) {
        const icon = element.querySelector('.icon');
        if (isMet) {
            element.className = 'password-requirement requirement-met';
            icon.textContent = '‚úì';
        } else {
            element.className = 'password-requirement requirement-not-met';
            icon.textContent = '‚ùå';
        }
    }

    // Authentication related functions
    async function apiCall(endpoint, method = 'GET', data = null) {
        const config = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
        };

        if (authToken) {
            config.headers['Authorization'] = `Bearer ${authToken}`;
        }

        if (data) {
            config.body = JSON.stringify(data);
        }

        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || `HTTP error! status: ${response.status}`);
            }
            
            return result;
        } catch (error) {
            console.error('API call failed:', error);
            throw error;
        }
    }
    
    // Learning record API functions
    async function startPracticeSession(sessionType, categories) {
        if (!currentUser || !authToken) {
            console.log('User not logged in, not recording learning data');
            return null;
        }
        
        try {
            const response = await apiCall('/practice/sessions/start/', 'POST', {
                session_type: sessionType,
                categories: categories
            });
            
            if (response.success) {
                currentSessionId = response.session_id;
                sessionStartTime = new Date();
                console.log('Practice session started:', currentSessionId);
                return response.session_id;
            }
        } catch (error) {
            console.error('Failed to start practice session:', error);
        }
        return null;
    }
    
    async function recordAnswerWithTime(questionKana, userAnswer, correctRomaji, isCorrect, responseTime) {
        if (!currentUser || !authToken || !currentSessionId) {
            return;
        }
        
        try {
            await apiCall('/practice/answers/', 'POST', {
                session_id: currentSessionId,
                question_kana: questionKana,
                user_answer: userAnswer,
                correct_romaji: correctRomaji,
                response_time_ms: responseTime
            });
            console.log('Answer recorded:', questionKana, userAnswer, isCorrect);
        } catch (error) {
            console.error('Failed to record answer:', error);
        }
    }
    
    async function completePracticeSession(finalScore, totalQuestions) {
        if (!currentUser || !authToken || !currentSessionId) {
            return;
        }
        
        try {
            const endTime = new Date();
            const durationSeconds = Math.round((endTime - sessionStartTime) / 1000);
            const accuracyRate = Math.round((finalScore / totalQuestions) * 100);
            
            const response = await apiCall(`/practice/sessions/${currentSessionId}/complete/`, 'POST', {
                total_questions: totalQuestions,
                correct_answers: finalScore,
                accuracy_rate: accuracyRate,
                duration_seconds: durationSeconds
            });
            
            if (response.success) {
                console.log('Practice session completed');
            }
            
            // Clear current session
            currentSessionId = null;
            sessionStartTime = null;
            
        } catch (error) {
            console.error('Failed to complete practice session:', error);
        }
    }
    
    async function getLearningStatistics() {
        if (!currentUser || !authToken) {
            return null;
        }
        
        try {
            const response = await apiCall('/practice/statistics/', 'GET');
            if (response.success) {
                return response;
            }
        } catch (error) {
            console.error('Failed to load learning statistics:', error);
        }
        return null;
    }
    
    // ËºâÂÖ•Â≠∏ÁøíÁµ±Ë®àÈ†ÅÈù¢
    async function loadStatistics() {
        console.log('loadStatistics called, currentUser:', currentUser, 'authToken:', !!authToken);
        
        const loadingEl = document.getElementById('statistics-loading');
        const contentEl = document.getElementById('statistics-content');
        
        if (loadingEl) {
            loadingEl.style.display = 'block';
            loadingEl.textContent = t('common.loading');
        }
        if (contentEl) contentEl.style.display = 'none';
        
        if (!currentUser || !authToken) {
            console.log('No user or token, showing login message');
            if (loadingEl) loadingEl.textContent = t('stats.loginRequired');
            return;
        }
        
        const stats = await getLearningStatistics();
        console.log('Statistics received:', stats);
        
        if (stats) {
            // Êõ¥Êñ∞Á∏ΩÈ´îÁµ±Ë®à
            const overall = stats.overall;
            document.getElementById('total-sessions-num').textContent = overall.total_sessions;
            document.getElementById('total-questions-num').textContent = overall.total_questions;
            document.getElementById('total-correct-num').textContent = overall.total_correct;
            document.getElementById('avg-accuracy-num').textContent = overall.avg_accuracy + '%';
            document.getElementById('total-time-num').textContent = overall.total_time_minutes;
            
            // È°ØÁ§∫ÊúÄËøëÁ∑¥ÁøíË®òÈåÑ
            const recentList = document.getElementById('recent-sessions-list');
            if (recentList && stats.recent_sessions) {
                let html = '';
                stats.recent_sessions.forEach(session => {
                    const date = new Date(session.started_at).toLocaleDateString();
                    const time = new Date(session.started_at).toLocaleTimeString();
                    const sessionTypeText = translateType(session.session_type);
                    const categoriesText = session.categories.map(cat => translateType(cat)).join(', ');
                    
                    html += `<div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 6px; cursor: pointer; transition: background 0.2s;" 
                             onclick="showSessionDetail(${session.id})" 
                             onmouseover="this.style.background='#e9ecef'" 
                             onmouseout="this.style.background='#f8f9fa'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${sessionTypeText}</strong> - ${categoriesText}
                                <br><small>${date} ${time}</small>
                                <br><small style="color: #667eea;">${t('stats.clickForDetail')}</small>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #667eea; font-weight: bold;">${session.accuracy_rate}%</div>
                                <small>${session.correct_answers}/${session.total_questions}</small>
                            </div>
                        </div>
                    </div>`;
                });
                recentList.innerHTML = html;
            }
            
            // È°ØÁ§∫ÂêÑÈ°ûÂà•Áµ±Ë®à
            const categoryList = document.getElementById('category-stats-list');
            if (categoryList && stats.by_category) {
                let html = '';
                stats.by_category.forEach(category => {
                    const kanaTypeText = translateType(category.kana_type) || category.kana_type;
                    const categoryText = translateType(category.category) || category.category;
                    const timesText = t('common.times');
                    const totalPracticeText = t('stats.totalPractice');
                    
                    html += `<div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${kanaTypeText}</strong> - ${categoryText}
                            <br><small>${totalPracticeText}: ${category.total_attempts} ${timesText}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #667eea; font-weight: bold;">${category.accuracy_rate}%</div>
                            <small>${category.correct_attempts}/${category.total_attempts}</small>
                        </div>
                    </div>`;
                });
                categoryList.innerHTML = html;
            }
            
            if (loadingEl) loadingEl.style.display = 'none';
            if (contentEl) contentEl.style.display = 'block';
        } else {
            if (loadingEl) loadingEl.textContent = t('stats.cannotLoad');
        }
    }
    
    // È°ØÁ§∫Á∑¥ÁøíË®òÈåÑË©≥ÊÉÖ
    async function showSessionDetail(sessionId) {
        const modal = document.getElementById('session-detail-modal');
        const content = document.getElementById('session-detail-content');
        const loading = document.getElementById('session-detail-loading');
        
        if (!modal) return;
        
        modal.style.display = 'block';
        if (loading) loading.style.display = 'block';
        
        // ‰ΩøÁî® i18next t() ÂáΩÊï∏Êõø‰ª£ËàäÁöÑ texts[lang]
        
        // Êõ¥Êñ∞Ê®°ÊÖãË¶ñÁ™óÊ®ôÈ°åÂíåËºâÂÖ•ÊñáÂ≠ó
        const titleEl = document.getElementById('session-detail-title');
        const loadingTextEl = document.getElementById('session-detail-loading');
        
        if (titleEl) titleEl.textContent = t('sessionDetail.title');
        if (loadingTextEl) loadingTextEl.textContent = t('common.loading');
        
        try {
            const response = await apiCall(`/practice/sessions/${sessionId}/`, 'GET');
            
            if (response.success) {
                const session = response.session;
                const sessionTypeText = translateType(session.session_type);
                const categoriesText = session.categories.map(cat => translateType(cat)).join(', ');
                const startDate = new Date(session.started_at);
                const endDate = new Date(session.completed_at);
                
                const typeLabel = t('sessionDetail.practiceType');
                const rangeLabel = t('sessionDetail.practiceRange');
                const startLabel = t('sessionDetail.startTime');
                const endLabel = t('sessionDetail.endTime');
                const durationLabel = t('sessionDetail.duration');
                const resultLabel = t('sessionDetail.result');
                const recordsLabel = t('sessionDetail.answerRecords');
                const detailTitle = t('sessionDetail.title');
                const minuteText = t('common.minutes');
                
                let detailHtml = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">${detailTitle}</h4>
                        <p><strong>${typeLabel}:</strong> ${sessionTypeText}</p>
                        <p><strong>${rangeLabel}:</strong> ${categoriesText}</p>
                        <p><strong>${startLabel}:</strong> ${startDate.toLocaleString()}</p>
                        <p><strong>${endLabel}:</strong> ${endDate.toLocaleString()}</p>
                        <p><strong>${durationLabel}:</strong> ${Math.round(session.duration_seconds / 60)} ${minuteText}</p>
                        <p><strong>${resultLabel}:</strong> ${session.correct_answers}/${session.total_questions} (${session.accuracy_rate}%)</p>
                    </div>
                    
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">${recordsLabel}</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                `;
                
                // È°ØÁ§∫ÊâÄÊúâÁ≠îÈ°åË®òÈåÑ
                if (session.answer_records && session.answer_records.length > 0) {
                    session.answer_records.forEach((record, index) => {
                        const isCorrect = record.is_correct;
                        const recordClass = isCorrect ? 'answer-correct' : 'answer-incorrect';
                        const icon = isCorrect ? '‚úì' : '‚úó';
                        const responseTime = (record.response_time_ms / 1000).toFixed(1);
                        
                        detailHtml += `
                            <div class="answer-record ${recordClass}">
                                <div>
                                    <span class="kana-large">${record.question_kana}</span>
                                    <span style="margin-left: 10px; color: #666;">${t('sessionDetail.correct')}: ${record.correct_romaji}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div>
                                        <span style="font-weight: bold;">${icon} ${record.user_answer}</span>
                                        <span style="margin-left: 10px; font-size: 12px; color: #666;">${responseTime}s</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    // ÈåØÈ°åË§áÁøíÊåâÈàï
                    const wrongAnswers = session.answer_records.filter(record => !record.is_correct);
                    if (wrongAnswers.length > 0) {
                        detailHtml += `
                            <div style="margin-top: 20px; text-align: center;">
                                <button onclick="startReviewSession(${sessionId})" 
                                        style="background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
${t('sessionDetail.reviewWrongAnswers')} (${wrongAnswers.length} ${t('common.questions')})
                                </button>
                            </div>
                        `;
                    }
                } else {
                    detailHtml += `<p style="text-align: center; color: #666;">${t('sessionDetail.noAnswerRecords')}</p>`;
                }
                
                detailHtml += '</div>';
                
                if (loading) loading.style.display = 'none';
                if (content) content.innerHTML = detailHtml;
            }
        } catch (error) {
            console.error('Failed to load session details:', error);
            if (loading) loading.style.display = 'none';
            if (content) content.innerHTML = `<p style="color: #e74c3c; text-align: center;">${t('sessionDetail.cannotLoadDetails')}</p>`;
        }
    }
    
    // ÈóúÈñâË©≥ÊÉÖÊ®°ÊÖãË¶ñÁ™ó
    function closeSessionDetail() {
        document.getElementById('session-detail-modal').style.display = 'none';
    }
    
    // ÈåØÈ°åË§áÁøíÂäüËÉΩ
    async function startReviewSession(sessionId) {
        try {
            const response = await apiCall(`/practice/sessions/${sessionId}/`, 'GET');
            
            if (response.success) {
                const session = response.session;
                const wrongAnswers = session.answer_records.filter(record => !record.is_correct);
                
                if (wrongAnswers.length > 0) {
                    // Ê∫ñÂÇôÈåØÈ°åË§áÁøíÊï∏Êìö
                    const reviewData = wrongAnswers.map(record => [record.question_kana, record.correct_romaji]);
                    
                    // ÈóúÈñâÊ®°ÊÖãË¶ñÁ™ó
                    closeSessionDetail();
                    
                    // ÂàáÊèõÂà∞Á∑¥ÁøíÊ®°Âºè‰∏¶ÈñãÂßãÈåØÈ°åË§áÁøí
                    showTab('practice');
                    startReviewQuiz(reviewData, session.session_type);
                }
            }
        } catch (error) {
            console.error('Wrong answer review failed:', error);
            alert(t('sessionDetail.reviewFailed'));
        }
    }
    
    // ÈñãÂßãÈåØÈ°åË§áÁøí
    function startReviewQuiz(reviewData, sessionType) {
        selected = shuffle(reviewData);
        current = 0;
        score = 0;
        total = selected.length;
        
        // Wrong answer review not recorded to database, just practice
        currentSessionId = null;
        
        // Hide options area, show practice content
        const practiceTab = document.getElementById("practice-tab");
        const chartTab = document.getElementById("chart-tab");
        const navTabs = document.querySelector(".nav-tabs");
        const languageSelect = document.querySelector('div[style*="margin-bottom: 20px"]');
        
        if (practiceTab) {
            const checkboxGrid = practiceTab.querySelector(".checkbox-grid");
            const modeSelect = practiceTab.querySelector(".mode-select");
            const startBtn = document.getElementById("start-btn");
            
            if (checkboxGrid) checkboxGrid.style.display = "none";
            if (modeSelect) modeSelect.style.display = "none";
            if (startBtn) startBtn.style.display = "none";
            if (navTabs) navTabs.style.display = "none";
            if (chartTab) chartTab.style.display = "none";
            if (languageSelect) languageSelect.style.display = "none";
            
            // Create wrong answer review title
            let quizHeader = document.createElement("div");
            quizHeader.id = "quiz-header";
            quizHeader.style.cssText = "display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 15px; background: rgba(255,200,200,0.9); border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 2px solid #e74c3c;";
            
            const backButton = document.createElement("button");
            backButton.innerHTML = "‚Üê " + t('practice.backBtn');
            backButton.style.cssText = "background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;";
            backButton.onclick = returnToMenu;
            
            const titleContainer = document.createElement("div");
            titleContainer.style.cssText = "text-align: center;";
            
            const title = document.createElement("h2");
            title.style.cssText = "margin: 0; color: #e74c3c; display: flex; align-items: center; gap: 8px;";
            title.innerHTML = "üîÑ " + t('practice.reviewMode');
            
            const subtitle = document.createElement("div");
            subtitle.style.cssText = "font-size: 12px; color: #666; margin-top: 4px;";
            subtitle.textContent = `${total} ${t('common.questions')}`;
            
            titleContainer.appendChild(title);
            titleContainer.appendChild(subtitle);
            
            // Add language selector to review mode header
            const languageContainer = document.createElement("div");
            languageContainer.style.cssText = "display: flex; align-items: center; gap: 8px;";
            
            const langLabel = document.createElement("label");
            langLabel.textContent = "üåê";
            langLabel.style.cssText = "font-size: 14px; color: #666;";
            
            const langSelect = document.createElement("select");
            langSelect.id = "review-language";
            langSelect.style.cssText = "padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;";
            
            // Add language options
            const zhOption = document.createElement("option");
            zhOption.value = "zh";
            zhOption.textContent = getCurrentLanguage() === 'en' ? 'Chinese' : '‰∏≠Êñá';
            const enOption = document.createElement("option");
            enOption.value = "en";
            enOption.textContent = "English";
            
            langSelect.appendChild(zhOption);
            langSelect.appendChild(enOption);
            langSelect.value = getCurrentLanguage();
            
            // Add event listener for language change
            langSelect.addEventListener('change', async function() {
                await changeLanguage(this.value);
                syncAllLanguageSelectors();
                // Update review mode UI
                updateReviewModeTexts();
            });
            
            languageContainer.appendChild(langLabel);
            languageContainer.appendChild(langSelect);
            
            quizHeader.appendChild(backButton);
            quizHeader.appendChild(titleContainer);
            quizHeader.appendChild(languageContainer);
            
            practiceTab.insertBefore(quizHeader, practiceTab.firstChild);
        }
        
        // Á¢∫‰øùÊ∏¨È©óÂçÄÂüüÂ≠òÂú®ÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂâáÂâµÂª∫
        let quizArea = document.getElementById("quiz-area");
        if (!quizArea) {
            console.log("Creating quiz area for review mode...");
            quizArea = document.createElement("div");
            quizArea.id = "quiz-area";
            quizArea.style.cssText = "display: block;";
            
            // ÂâµÂª∫ÈÄ≤Â∫¶Ê¢ù
            const progressBar = document.createElement("div");
            progressBar.className = "progress-bar";
            progressBar.style.cssText = "width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; margin-bottom: 20px; overflow: hidden;";
            
            const progressFill = document.createElement("div");
            progressFill.className = "progress-fill";
            progressFill.id = "progress";
            progressFill.style.cssText = "height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s ease;";
            
            progressBar.appendChild(progressFill);
            
            // ÂâµÂª∫Áµ±Ë®àÂçÄÂüü
            const stats = document.createElement("div");
            stats.className = "stats";
            stats.style.cssText = "display: flex; justify-content: space-around; margin-bottom: 30px; background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);";
            
            const statItems = [
                { id: "current-num", labelId: "stat-current", value: "1" },
                { id: "total-num", labelId: "stat-total", value: total.toString() },
                { id: "score-num", labelId: "stat-score", value: "0" },
                { id: "accuracy", labelId: "stat-accuracy", value: "0%" }
            ];
            
            statItems.forEach(item => {
                const statItem = document.createElement("div");
                statItem.className = "stat-item";
                statItem.style.cssText = "text-align: center;";
                
                const statNumber = document.createElement("div");
                statNumber.className = "stat-number";
                statNumber.id = item.id;
                statNumber.style.cssText = "font-size: 24px; font-weight: bold; color: #2c3e50;";
                statNumber.textContent = item.value;
                
                const statLabel = document.createElement("div");
                statLabel.className = "stat-label";
                statLabel.id = item.labelId;
                statLabel.style.cssText = "font-size: 14px; color: #666;";
                
                statItem.appendChild(statNumber);
                statItem.appendChild(statLabel);
                stats.appendChild(statItem);
            });
            
            // ÂâµÂª∫Ê∏¨È©óÂÆπÂô®
            const quizContainer = document.createElement("div");
            quizContainer.className = "quiz-container";
            quizContainer.style.cssText = "display: flex; flex-direction: column; align-items: center; text-align: center; background: rgba(255,255,255,0.95); padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);";
            
            // ÂâµÂª∫ÂÅáÂêçÈ°ØÁ§∫
            const kanaDiv = document.createElement("div");
            kanaDiv.className = "kana";
            kanaDiv.id = "kana";
            kanaDiv.style.cssText = "font-size: 72px; margin: 20px; color: #2c3e50; text-align: center; font-weight: bold;";
            
            // ÂâµÂª∫Á≠îÊ°àËº∏ÂÖ•Ê°Ü
            const answerInput = document.createElement("input");
            answerInput.id = "answer";
            answerInput.placeholder = t('practice.enterRomaji');
            answerInput.style.cssText = "padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; margin: 10px; width: 200px; text-align: center;";
            answerInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    checkAnswer();
                }
            });
            
            // ÂâµÂª∫Êèê‰∫§ÊåâÈàï
            const submitBtn = document.createElement("button");
            submitBtn.id = "submit-btn";
            submitBtn.textContent = t('practice.submitAnswer');
            submitBtn.style.cssText = "padding: 12px 24px; font-size: 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px;";
            submitBtn.addEventListener('click', checkAnswer);
            
            // ÂâµÂª∫ÂèçÈ•ãÂçÄÂüü
            const feedbackDiv = document.createElement("div");
            feedbackDiv.className = "result";
            feedbackDiv.id = "feedback";
            feedbackDiv.style.cssText = "font-size: 18px; margin: 20px; font-weight: 500; min-height: 25px;";
            
            // ÂâµÂª∫ÂíñÊ≥¢ÂúñÁâá
            const kaboImg = document.createElement("img");
            kaboImg.src = "kabo-seed.gif";
            kaboImg.alt = "Kabo Seed GIF";
            kaboImg.style.cssText = "width: 300px; height: auto; margin-top: 20px;";
            
            // ÁµÑË£ùÊâÄÊúâÂÖÉÁ¥†
            quizContainer.appendChild(kanaDiv);
            quizContainer.appendChild(answerInput);
            quizContainer.appendChild(submitBtn);
            quizContainer.appendChild(feedbackDiv);
            quizContainer.appendChild(kaboImg);
            
            quizArea.appendChild(progressBar);
            quizArea.appendChild(stats);
            quizArea.appendChild(quizContainer);
            
            practiceTab.appendChild(quizArea);
            console.log("Quiz area created for review mode");
            
            // Á´ãÂç≥Êõ¥Êñ∞Êñ∞ÂâµÂª∫ÂÖÉÁ¥†ÁöÑÊñáÂ≠ó
            updateDynamicPracticeElements();
        } else {
            quizArea.style.display = "block";
            console.log("Quiz area already exists, showing it");
        }
        
        const totalNumEl = document.getElementById("total-num");
        if (totalNumEl) totalNumEl.innerText = total;
        
        updateStats();
        nextQuestion();
        showQuizContent();
    }
    
    // Êõ¥Êñ∞ÈåØÈ°åË§áÁøíÊ®°ÂºèÁöÑÊñáÂ≠ó
    function updateReviewModeTexts() {
        const quizHeader = document.getElementById('quiz-header');
        if (quizHeader) {
            const backButton = quizHeader.querySelector('button');
            const title = quizHeader.querySelector('h2');
            const subtitle = quizHeader.querySelector('div[style*="font-size: 12px"]');
            
            if (backButton) backButton.innerHTML = "‚Üê " + t('practice.backBtn');
            if (title) title.innerHTML = "üîÑ " + t('practice.reviewMode');
            if (subtitle) subtitle.textContent = `${total} ${t('common.questions')}`;
        }
        
        // Êõ¥Êñ∞Á≠îÊ°àËº∏ÂÖ•Ê°ÜÂíåÊèê‰∫§ÊåâÈàï
        const answerInput = document.getElementById('answer');
        const submitBtn = document.getElementById('submit-btn');
        if (answerInput) answerInput.placeholder = t('practice.enterRomaji');
        if (submitBtn) submitBtn.textContent = t('practice.submitAnswer');
        
        // ÂêåÊ≠•Ë™ûË®ÄÈÅ∏ÊìáÂô®
        const reviewLanguageSelect = document.getElementById('review-language');
        if (reviewLanguageSelect) {
            reviewLanguageSelect.value = getCurrentLanguage();
        }
    }

    function showMessage(elementId, message, isError = false) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.className = isError ? 'error-message' : 'success-message';
        
        // 3ÁßíÂæåÊ∏ÖÈô§Ë®äÊÅØ
        setTimeout(() => {
            element.textContent = '';
            element.className = '';
        }, 3000);
    }

    function switchAuthTab(tabName) {
        // ÂàáÊèõÊ®ôÁ±§Ê¥ªÂãïÁãÄÊÖã
        document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        // ÂàáÊèõË°®ÂñÆÈ°ØÁ§∫
        document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
        document.getElementById(`${tabName}-form`).classList.add('active');
    }

    async function handleLogin(event) {
        event.preventDefault();
        
        const identifier = document.getElementById('login-identifier').value;
        const password = document.getElementById('login-password').value;
        const button = document.getElementById('login-button');
        
        button.disabled = true;
        button.textContent = t('auth.loggingIn');
        
        try {
            const response = await apiCall('/auth/login/', 'POST', {
                identifier: identifier,
                password: password
            });
            
            if (response.success) {
                authToken = response.token;
                currentUser = response.user;
                
                // ÂÑ≤Â≠òÂà∞ localStorage
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                showAuthenticatedApp();
                showMessage('login-message', t('common.success'));
            }
        } catch (error) {
            showMessage('login-message', error.message || t('common.error'), true);
        } finally {
            button.disabled = false;
            button.textContent = t('app.login');
        }
    }

    async function handleRegister(event) {
        event.preventDefault();
        
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const displayName = document.getElementById('register-display-name').value;
        const password = document.getElementById('register-password').value;
        const passwordConfirm = document.getElementById('register-password-confirm').value;
        const button = document.getElementById('register-button');
        
        if (password !== passwordConfirm) {
            showMessage('register-message', t('auth.passwordMismatch'), true);
            return;
        }
        
        button.disabled = true;
        button.textContent = t('auth.registering');
        
        const preferredLanguage = document.getElementById('register-language').value;
        
        try {
            const response = await apiCall('/auth/register/', 'POST', {
                username: username,
                email: email,
                display_name: displayName,
                password: password,
                password_confirm: passwordConfirm,
                preferred_language: preferredLanguage
            });
            
            if (response.success) {
                authToken = response.token;
                currentUser = response.user;
                
                // ÂÑ≤Â≠òÂà∞ localStorage
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                showAuthenticatedApp();
                showMessage('register-message', t('common.success'));
            }
        } catch (error) {
            const errorMessage = error.message || t('common.error');
            showMessage('register-message', errorMessage, true);
        } finally {
            button.disabled = false;
            button.textContent = t('app.register');
        }
    }

    // Google OAuth ÂäüËÉΩ
    function initGoogleSignIn() {
        if (!isGoogleOAuthConfigured()) {
            console.log('Google OAuth not configured');
            return;
        }
        
        if (typeof google === 'undefined') {
            console.log('Google Sign-In API not loaded');
            setTimeout(initGoogleSignIn, 1000);
            return;
        }

        // ÂàùÂßãÂåñ Google Sign-In
        google.accounts.id.initialize({
            client_id: appConfig.googleClientId,
            callback: handleGoogleLoginCallback,
            auto_select: false,
            cancel_on_tap_outside: true,
            origin: window.location.origin
        });

        // Ê∏≤ÊüìÁôªÂÖ•ÊåâÈàï
        const loginButton = document.getElementById('google-signin-button');
        if (loginButton) {
            google.accounts.id.renderButton(loginButton, {
                theme: 'outline',
                size: 'large',
                text: 'signin_with',
                shape: 'rectangular',
                logo_alignment: 'left'
            });
        }

        // Ê∏≤ÊüìË®ªÂÜäÊåâÈàï
        const registerButton = document.getElementById('google-register-button');
        if (registerButton) {
            google.accounts.id.renderButton(registerButton, {
                theme: 'filled_blue',
                size: 'large',
                text: 'signup_with',
                shape: 'rectangular',
                logo_alignment: 'left'
            });
        }
    }

    function updateGoogleOAuthVisibility() {
        const elements = [
            document.querySelector('.oauth-divider'),
            document.getElementById('google-signin-button'),
            document.querySelector('.oauth-divider:nth-of-type(2)'),
            document.getElementById('google-register-button')
        ];
        
        const isConfigured = isGoogleOAuthConfigured();
        elements.forEach(el => {
            if (el) el.style.display = isConfigured ? 'block' : 'none';
        });
    }

    async function handleGoogleLoginCallback(response) {
        console.log('Google login callback received:', response);
        
        try {
            const result = await apiCall('/auth/oauth/google/', 'POST', {
                token: response.credential
            });
            
            if (result.success) {
                authToken = result.token;
                currentUser = result.user;
                
                // ÂÑ≤Â≠òÂà∞ localStorage
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                if (result.is_new_user) {
                    // Êñ∞Áî®Êà∂Â∞éÂêëÂÄã‰∫∫Ë≥áÊñôË®≠ÂÆöÈ†ÅÈù¢
                    showGoogleProfileSetup();
                } else {
                    // ÁèæÊúâÁî®Êà∂Áõ¥Êé•ÈÄ≤ÂÖ•ÊáâÁî®
                    showAuthenticatedApp();
                    showMessage('login-message', t('auth.googleLoginSuccess'));
                }
            }
        } catch (error) {
            console.error('Google OAuth error:', error);
            showMessage('login-message', error.message || t('common.error'), true);
        }
    }

    // Google ÂÄã‰∫∫Ë≥áÊñôË®≠ÂÆöÈ†ÅÈù¢
    function showGoogleProfileSetup() {
        // Èö±Ëóè‰∏ªÊáâÁî®ÂíåË™çË≠âÈ†ÅÈù¢
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('auth-screen').classList.add('hidden');
        
        // È°ØÁ§∫ Google Ë®≠ÂÆöÈ†ÅÈù¢
        document.getElementById('google-profile-setup').classList.remove('hidden');
        
        // Êõ¥Êñ∞È†ÅÈù¢ÊñáÂ≠ó
        updateGoogleProfileTexts();
        
        // È†êÂ°´Áî®Êà∂Ë≥áË®ä
        if (currentUser) {
            document.getElementById('google-nickname').value = currentUser.display_name || '';
            document.getElementById('google-language').value = currentUser.preferred_language || getCurrentLanguage();
        }
    }

    function updateGoogleProfileTexts() {
        const elements = {
            'complete-profile-title': 'auth.completeProfile',
            'google-nickname-label': 'auth.nickname',
            'google-birth-date-label': 'auth.birthDate',
            'google-language-label': 'auth.preferredLanguage',
            'skip-setup-btn': 'auth.skipSetup',
            'save-profile-btn': 'auth.saveProfile'
        };
        
        Object.entries(elements).forEach(([id, key]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = t(key);
        });
        
        // Êõ¥Êñ∞subtitle
        const subtitle = document.getElementById('complete-profile-subtitle');
        if (subtitle && currentUser) {
            subtitle.textContent = getCurrentLanguage() === 'en' ? 
                `Welcome, ${currentUser.email}! Please complete your profile.` : 
                `Ê≠°ËøéÔºå${currentUser.email}ÔºÅË´ãÂÆåÊàêÊÇ®ÁöÑÂÄã‰∫∫Ë≥áÊñô„ÄÇ`;
        }
        
        // Êõ¥Êñ∞ placeholder
        const nicknameInput = document.getElementById('google-nickname');
        if (nicknameInput) nicknameInput.placeholder = t('auth.nicknamePlaceholder');
        
        // Êõ¥Êñ∞Ë™ûË®ÄÈÅ∏ÊìáÂô®
        updateGoogleLanguageSelector();
    }

    function updateGoogleLanguageSelector() {
        const languageSelect = document.getElementById('google-language');
        if (languageSelect) {
            const currentValue = languageSelect.value;
            languageSelect.innerHTML = '';
            
            const zhOption = document.createElement('option');
            zhOption.value = 'zh';
            zhOption.textContent = getCurrentLanguage() === 'en' ? 'Chinese' : '‰∏≠Êñá';
            
            const enOption = document.createElement('option');
            enOption.value = 'en';
            enOption.textContent = 'English';
            
            languageSelect.appendChild(zhOption);
            languageSelect.appendChild(enOption);
            languageSelect.value = currentValue || getCurrentLanguage();
        }
    }

    async function skipGoogleSetup() {
        showAuthenticatedApp();
        showMessage('google-profile-message', t('auth.googleRegisterSuccess'));
    }

    async function handleGoogleProfileSubmit(event) {
        event.preventDefault();
        
        const nickname = document.getElementById('google-nickname').value;
        const birthDate = document.getElementById('google-birth-date').value;
        const language = document.getElementById('google-language').value;
        const button = document.getElementById('save-profile-btn');
        
        button.disabled = true;
        
        try {
            const result = await apiCall('/auth/profile/update/', 'PUT', {
                display_name: nickname,
                birth_date: birthDate,
                preferred_language: language
            });
            
            if (result.success) {
                currentUser = result.user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Â¶ÇÊûúË™ûË®ÄÊúâËÆäÊõ¥ÔºåÊõ¥Êñ∞ÁïåÈù¢Ë™ûË®Ä
                if (language !== getCurrentLanguage()) {
                    await changeLanguage(language);
                }
                
                showAuthenticatedApp();
                showMessage('google-profile-message', t('auth.googleRegisterSuccess'));
            }
        } catch (error) {
            showMessage('google-profile-message', error.message || t('common.error'), true);
        } finally {
            button.disabled = false;
        }
    }

    function showAuthenticatedApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('google-profile-setup').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        
        // È°ØÁ§∫Áî®Êà∂Ë≥áË®äÔºåÈö±ËóèÈÅäÂÆ¢Ë®äÊÅØ
        document.getElementById('user-info').style.display = 'block';
        document.getElementById('guest-info').style.display = 'none';
        
        // È°ØÁ§∫Áµ±Ë®àÊ®ôÁ±§
        const statisticsNavTab = document.getElementById('statistics-nav-tab');
        if (statisticsNavTab) statisticsNavTab.style.display = 'block';
        
        // Êõ¥Êñ∞Áî®Êà∂Ë≥áË®äÈ°ØÁ§∫
        if (currentUser) {
            document.getElementById('user-name').textContent = currentUser.display_name || currentUser.username;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('user-avatar').textContent = (currentUser.display_name || currentUser.username).charAt(0).toUpperCase();
        }
    }

    function showAuthScreen() {
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
    }
    
    function showGuestApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        
        // È°ØÁ§∫ÈÅäÂÆ¢Ë®äÊÅØÔºåÈö±ËóèÁî®Êà∂Ë≥áË®ä
        document.getElementById('user-info').style.display = 'none';
        document.getElementById('guest-info').style.display = 'block';
        
        // Èö±ËóèÁµ±Ë®àÊ®ôÁ±§
        const statisticsNavTab = document.getElementById('statistics-nav-tab');
        if (statisticsNavTab) statisticsNavTab.style.display = 'none';
    }

    function logout() {
        authToken = null;
        currentUser = null;
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');
        showGuestApp();
        
        // Ê∏ÖÁ©∫Ë°®ÂñÆ
        document.getElementById('login-form').reset();
        document.getElementById('register-form').reset();
    }

    function checkAuthStatus() {
        const storedToken = localStorage.getItem('authToken');
        const storedUser = localStorage.getItem('currentUser');
        
        if (storedToken && storedUser) {
            authToken = storedToken;
            try {
                currentUser = JSON.parse(storedUser);
                showAuthenticatedApp();
            } catch (error) {
                console.error('Failed to parse stored user data:', error);
                showGuestApp();
            }
        } else {
            showGuestApp();
        }
    }

    function setupAuthEventListeners() {
        // Ë™çË≠âÊ®ôÁ±§ÂàáÊèõ
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                switchAuthTab(tab.getAttribute('data-auth-tab'));
            });
        });
        
        // ÁôªÂÖ•Ë°®ÂñÆ
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        
        // Ë®ªÂÜäË°®ÂñÆ
        document.getElementById('register-form').addEventListener('submit', handleRegister);
        
        // Google ÂÄã‰∫∫Ë≥áÊñôË°®ÂñÆ
        document.getElementById('google-profile-form').addEventListener('submit', handleGoogleProfileSubmit);
        
        // ÁôªÂá∫ÊåâÈàï
        document.getElementById('logout-btn').addEventListener('click', logout);
    }

    // ÂàùÂßãÂåñ
    async function initializePage() {
        // ÂàùÂßãÂåñ i18next
        await initI18n();
        
        // Ë®≠ÁΩÆË™ûË®ÄÈÅ∏ÊìáÂô®
        const languageSelect = document.getElementById('language-select');
        if (languageSelect) {
            languageSelect.value = getCurrentLanguage();
            languageSelect.addEventListener('change', async (e) => {
                await changeLanguage(e.target.value);
            });
        }
        
        // Êõ¥Êñ∞ÊâÄÊúâÊñáÂ≠ó
        updateAllTexts();
        updateChart();
        
        // Êõ¥Êñ∞ Google OAuth ÂèØË¶ãÊÄß
        updateGoogleOAuthVisibility();
        
        // ÂàùÂßãÂåñ Google Sign-In
        initGoogleSignIn();
        
        // Ë®≠ÁΩÆË™çË≠â‰∫ã‰ª∂Áõ£ËÅΩÂô®
        setupAuthEventListeners();
        
        // Ê™¢Êü•Ë™çË≠âÁãÄÊÖã
        checkAuthStatus();
        
        // Á∂ÅÂÆöÊâÄÊúâ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        setupEventListeners();
        
        console.log("Page initialized with i18next"); // Debug info
    }
    
    // Ë®≠ÁΩÆÊâÄÊúâ‰∫ã‰ª∂Áõ£ËÅΩÂô®
    function setupEventListeners() {
        console.log("Setting up event listeners...");
        
        // ÈñãÂßãÁ∑¥ÁøíÊåâÈàï
        const startBtn = document.getElementById("start-btn");
        if (startBtn) {
            // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
            startBtn.removeEventListener('click', startQuiz);
            startBtn.addEventListener('click', startQuiz);
            console.log("Start button event listener added");
        } else {
            console.log("Start button not found");
        }
        
        // Ë™ûË®ÄÈÅ∏Êìá
        const languageSelect = document.getElementById("language");
        if (languageSelect) {
            // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
            languageSelect.removeEventListener('change', setLanguage);
            languageSelect.addEventListener('change', setLanguage);
            console.log("Language select event listener added");
        } else {
            console.log("Language select not found");
        }
        
        // Â∞éËà™Ê®ôÁ±§
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => {
            // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
            tab.removeEventListener('click', tabClickHandler);
            tab.addEventListener('click', tabClickHandler);
        });
        console.log("Nav tabs event listeners added:", navTabs.length);
        
        // ÂÅáÂêçÈ°ûÂûãÈÅ∏Êìá
        const kanaTypeRadios = document.querySelectorAll('input[name="kana-type"]');
        kanaTypeRadios.forEach(radio => {
            // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
            radio.removeEventListener('change', updateCategoryLabels);
            radio.addEventListener('change', updateCategoryLabels);
        });
        console.log("Kana type radios event listeners added:", kanaTypeRadios.length);
        
        // ‰∫îÂçÅÈü≥Ë°®È°ûÂûãÈÅ∏Êìá
        const chartTypeRadios = document.querySelectorAll('input[name="chart-type"]');
        chartTypeRadios.forEach(radio => {
            // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
            radio.removeEventListener('change', updateChart);
            radio.addEventListener('change', updateChart);
        });
        console.log("Chart type radios event listeners added:", chartTypeRadios.length);
        
        // Á≠îÊ°àËº∏ÂÖ•Ê°ÜÂíåÈÄÅÂá∫ÊåâÈàïÔºàÈÄô‰∫õÂèØËÉΩÂú®ÂãïÊÖãÂâµÂª∫ÊôÇÊâçÂ≠òÂú®Ôºâ
        setupQuizEventListeners();
        
        console.log("All event listeners set up successfully");
    }
    
    // Ë®≠ÁΩÆÊ∏¨È©óÁõ∏ÈóúÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
    function setupQuizEventListeners() {
        // Á≠îÊ°àËº∏ÂÖ•Ê°Ü
        const answerInput = document.getElementById("answer");
        if (answerInput) {
            // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
            answerInput.removeEventListener('keydown', answerKeydownHandler);
            answerInput.addEventListener('keydown', answerKeydownHandler);
            console.log("Answer input event listener added");
        }
        
        // ÈÄÅÂá∫ÊåâÈàï
        const submitBtn = document.getElementById("submit-btn");
        if (submitBtn) {
            // ÁßªÈô§ËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
            submitBtn.removeEventListener('click', checkAnswer);
            submitBtn.addEventListener('click', checkAnswer);
            console.log("Submit button event listener added");
        }
    }
    
    // Â∞éËà™Ê®ôÁ±§ÈªûÊìäËôïÁêÜÂô®
    function tabClickHandler() {
        const tabName = this.getAttribute('data-tab');
        console.log("Tab clicked:", tabName);
        showTab(tabName);
    }
    
    // Á≠îÊ°àËº∏ÂÖ•Ê°ÜÊåâÈçµËôïÁêÜÂô®
    function answerKeydownHandler(event) {
        if (event.key === 'Enter') {
            console.log("Enter key pressed in answer input");
            checkAnswer();
        }
    }
    
    // Êõ¥Êñ∞È°ûÂà•Ê®ôÁ±§
    function updateCategoryLabels() {
        const kanaType = document.querySelector('input[name="kana-type"]:checked').value;
        
        const catBasic = document.getElementById('cat-basic');
        const catDakuten = document.getElementById('cat-dakuten');
        const catHandakuten = document.getElementById('cat-handakuten');
        const catYouon = document.getElementById('cat-youon');
        
        if (catBasic) catBasic.textContent = t('kana.categories.basicWithExample');
        
        if (kanaType === 'katakana') {
            if (catDakuten) catDakuten.textContent = t('kana.categories.dakutenKatakana');
            if (catHandakuten) catHandakuten.textContent = t('kana.categories.handakutenKatakana');
            if (catYouon) catYouon.textContent = t('kana.categories.youonKatakana');
        } else {
            if (catDakuten) catDakuten.textContent = t('kana.categories.dakutenWithExample');
            if (catHandakuten) catHandakuten.textContent = t('kana.categories.handakutenWithExample');
            if (catYouon) catYouon.textContent = t('kana.categories.youonWithExample');
        }
    }
    
    // Áï∂È†ÅÈù¢Âä†ËºâÂÆåÊàêÊôÇÂàùÂßãÂåñ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePage);
    } else {
        initializePage();
    }
    </script>
</body>
</html>
