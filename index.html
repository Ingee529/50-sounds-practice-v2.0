<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Complete Japanese Kana Practice</title>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CR8D4QH6FF"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-CR8D4QH6FF');
    </script>
    <!-- End Google Analytics -->
    
    <!-- i18next internationalization library -->
    <script src="https://unpkg.com/i18next/dist/umd/i18next.min.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/config.js"></script>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { 
            font-family: "Helvetica", "Yu Gothic", sans-serif; 
            text-align: center; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .page-content {
            display: block;
        }
        .page-content.hidden {
            display: none;
        }
        .container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; margin-bottom: 30px; }
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }
        .nav-tab {
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 8px;
            margin: 0 5px;
            transition: all 0.3s;
            font-weight: 500;
        }
        .nav-tab.active {
            background: #667eea;
            color: white;
        }
        .nav-tab:hover {
            background: #e9ecef;
        }
        .nav-tab.active:hover {
            background: #5a6fd8;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        input, button, select { 
            padding: 12px; 
            font-size: 16px; 
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 5px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        .kana { 
            font-size: 72px; 
            margin: 20px; 
            color: #2c3e50;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .result { 
            font-size: 18px; 
            margin-top: 20px; 
            font-weight: 500;
        }
        .quiz-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 30px; 
            margin-top: 30px; 
        }
        .mode-select { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .mode-select label { 
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .mode-select label:hover {
            background: #e9ecef;
        }
        .checkbox-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; 
            margin: 20px 0;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .checkbox-group { 
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .checkbox-group:hover {
            border-color: #667eea;
        }
        .checkbox-group h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 16px;
        }
        .checkbox-group label { 
            display: block;
            margin: 8px 0;
            text-align: left;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .checkbox-group label:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        .chart-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .chart-table th, .chart-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .chart-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        .chart-table td {
            font-size: 18px;
            transition: background 0.2s;
        }
        .chart-table td:hover {
            background: #f8f9fa;
        }
        .kana-char {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .romaji {
            font-size: 14px;
            color: #666;
            font-family: monospace;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            min-width: 120px;
            margin: 5px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        @media (max-width: 768px) {
            .container { margin: 10px; padding: 20px; }
            .kana { font-size: 48px; }
            .checkbox-grid { grid-template-columns: 1fr; }
            .quiz-container { flex-direction: column; gap: 15px; }
        }
        
        /* 認證相關樣式 */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 30px;
            background: rgba(255,255,255,0.98);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
        }
        
        .auth-tab {
            flex: 1;
            padding: 8px 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .auth-tab.active {
            background: #667eea;
            color: white;
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .auth-button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .auth-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        
        .auth-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        
        /* Google OAuth 樣式 */
        .oauth-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }
        
        .oauth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e9ecef;
        }
        
        .oauth-divider span {
            background: white;
            padding: 0 15px;
            color: #6c757d;
            font-size: 14px;
        }
        
        .google-login-btn {
            width: 100%;
            padding: 12px;
            background: white;
            color: #3c4043;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .google-login-btn:hover {
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            background: #f8f9fa;
        }
        
        .google-login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .success-message {
            color: #27ae60;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .user-details {
            flex: 1;
            text-align: left;
        }
        
        .user-name {
            font-weight: 500;
            margin: 0;
        }
        
        .user-email {
            font-size: 12px;
            color: #666;
            margin: 0;
        }
        
        .logout-btn {
            padding: 6px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        .auth-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
        }
        
        .auth-btn:hover {
            background: #5a6fd8;
        }
        
        .password-input-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .password-toggle:hover {
            color: #333;
        }
        
        .password-requirements {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin-top: 5px;
            font-size: 12px;
        }
        
        .password-requirement {
            display: flex;
            align-items: center;
            margin: 4px 0;
            color: #666;
        }
        
        .password-requirement .icon {
            margin-right: 6px;
            width: 16px;
            text-align: center;
        }
        
        .requirement-met {
            color: #27ae60;
        }
        
        .requirement-not-met {
            color: #e74c3c;
        }
        
        /* 詳情模態視窗樣式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .answer-record {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .answer-correct {
            background: rgba(39, 174, 96, 0.1);
            border-left: 4px solid #27ae60;
        }
        
        .answer-incorrect {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
        }
        
        .kana-large {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- 認證界面 -->
    <div id="auth-screen" class="container hidden">
        <!-- 頂部導航區 -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="showGuestApp()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                ← <span id="back-to-guest"></span>
            </button>
            
            <!-- Authentication page language selection -->
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="auth-language" style="font-size: 14px; color: #666;">🌐</label>
                <select id="auth-language" onchange="setLanguageAndUpdateAuth()" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="zh">中文</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>
        
        <h1 id="auth-title"></h1>
        <p style="margin: -10px 0 30px 0; color: #666; font-size: 14px;" id="auth-author">Author: Ingee</p>
        
        <div class="auth-container">
            <div class="auth-tabs">
                <div class="auth-tab active" data-auth-tab="login" id="login-tab"></div>
                <div class="auth-tab" data-auth-tab="register" id="register-tab"></div>
            </div>
            
            <!-- 登入表單 -->
            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="login-identifier" id="login-identifier-label"></label>
                    <input type="text" id="login-identifier" required>
                </div>
                <div class="form-group">
                    <label for="login-password" id="login-password-label"></label>
                    <div class="password-input-container">
                        <input type="password" id="login-password" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('login-password')">👁</button>
                    </div>
                </div>
                <button type="submit" class="auth-button" id="login-button"></button>
                <div id="login-message"></div>
                
                <!-- Google Login Section -->
                <div class="oauth-divider">
                    <span id="oauth-divider-text"></span>
                </div>
                <div id="google-signin-button"></div>
            </form>
            
            <!-- 註冊表單 -->
            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <label for="register-username" id="register-username-label"></label>
                    <input type="text" id="register-username" required minlength="3">
                </div>
                <div class="form-group">
                    <label for="register-email" id="register-email-label"></label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-display-name" id="register-display-name-label"></label>
                    <input type="text" id="register-display-name" placeholder="">
                </div>
                <div class="form-group">
                    <label for="register-language" id="register-language-label"></label>
                    <select id="register-language" onchange="onLanguagePreferenceChange()" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; box-sizing: border-box;">
                    </select>
                </div>
                <div class="form-group">
                    <label for="register-password" id="register-password-label"></label>
                    <div class="password-input-container">
                        <input type="password" id="register-password" required minlength="8" oninput="validatePassword()">
                        <button type="button" class="password-toggle" onclick="togglePassword('register-password')">👁</button>
                    </div>
                    <div class="password-requirements" id="password-requirements">
                        <div class="password-requirement" id="req-length">
                            <span class="icon">❌</span>
                            <span id="req-length-text"></span>
                        </div>
                        <div class="password-requirement" id="req-letter">
                            <span class="icon">❌</span>
                            <span id="req-letter-text"></span>
                        </div>
                        <div class="password-requirement" id="req-number">
                            <span class="icon">❌</span>
                            <span id="req-number-text"></span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="register-password-confirm" id="register-password-confirm-label"></label>
                    <div class="password-input-container">
                        <input type="password" id="register-password-confirm" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('register-password-confirm')">👁</button>
                    </div>
                </div>
                <button type="submit" class="auth-button" id="register-button"></button>
                <div id="register-message"></div>
                
                <!-- Google Register Section -->
                <div class="oauth-divider">
                    <span id="oauth-divider-text-register"></span>
                </div>
                <div id="google-register-button"></div>
            </form>
        </div>
    </div>

    <!-- Google 註冊完成設定頁面 -->
    <div id="google-profile-setup" class="page-content hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 1000; overflow-y: auto;">
        <div class="container">
        <div class="auth-container">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 id="complete-profile-title"></h2>
                <p id="complete-profile-subtitle" style="color: #6c757d; margin: 10px 0;"></p>
            </div>
            
            <form id="google-profile-form">
                <div class="form-group">
                    <label for="google-nickname" id="google-nickname-label"></label>
                    <input type="text" id="google-nickname" placeholder="" maxlength="100">
                </div>
                
                <div class="form-group">
                    <label for="google-birth-date" id="google-birth-date-label"></label>
                    <input type="date" id="google-birth-date">
                </div>
                
                <div class="form-group">
                    <label for="google-language" id="google-language-label"></label>
                    <select id="google-language" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; box-sizing: border-box;">
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="auth-button" id="skip-setup-btn" onclick="skipGoogleSetup()" style="background: #6c757d; flex: 1;"></button>
                    <button type="submit" class="auth-button" id="save-profile-btn" style="flex: 2;"></button>
                </div>
                
                <div id="google-profile-message"></div>
            </form>
        </div>
        </div>
    </div>

    <!-- 主應用界面 -->
    <div id="main-app" class="container">
        <!-- 用戶資訊和登入按鈕區域 -->
        <div class="user-info" id="user-info" style="display: none;">
            <div class="user-avatar" id="user-avatar">U</div>
            <div class="user-details">
                <p class="user-name" id="user-name"></p>
                <p class="user-email" id="user-email">user@example.com</p>
            </div>
            <button class="logout-btn" id="logout-btn"></button>
        </div>
        
        <!-- 未登入用戶的登入按鈕區域 -->
        <div class="guest-info" id="guest-info">
            <div style="display: flex; align-items: center; gap: 15px; padding: 10px 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffc107;">
                <div style="font-size: 20px;">⚠️</div>
                <div style="flex: 1; text-align: left;">
                    <p style="margin: 0; font-weight: 500; color: #856404;" id="guest-mode-title"></p>
                    <p style="margin: 0; font-size: 12px; color: #856404;" id="guest-warning-text"></p>
                </div>
                <button class="auth-btn" id="login-signup-btn" onclick="showAuthScreen()"></button>
            </div>
        </div>

        <h1 id="title"></h1>
        <p style="margin: -10px 0 20px 0; color: #666; font-size: 14px;" id="main-author">Author: Ingee</p>

        <!-- Language selection -->
        <div style="margin-bottom: 20px;">
            <label for="language" id="language-label">🌐 Language:</label>
            <select id="language">
                <option value="zh">中文</option>
                <option value="en">English</option>
            </select>
        </div>

        <!-- Navigation tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="practice">
                <span id="nav-practice"></span>
            </div>
            <div class="nav-tab" data-tab="chart">
                <span id="nav-chart"></span>
            </div>
            <div class="nav-tab" data-tab="statistics" id="statistics-nav-tab" style="display: none;">
                <span id="nav-statistics"></span>
            </div>
        </div>

        <!-- Practice mode tab content -->
        <div id="practice-tab" class="tab-content active">
            <!-- Kana type selection -->
            <div class="mode-select">
                <label>
                    <input type="radio" name="kana-type" value="hiragana" checked>
                    <span id="type-hiragana"></span>
                </label>
                <label>
                    <input type="radio" name="kana-type" value="katakana">
                    <span id="type-katakana"></span>
                </label>
                <label>
                    <input type="radio" name="kana-type" value="mixed">
                    <span id="type-mixed"></span>
                </label>
            </div>

            <!-- Practice range selection -->
            <div class="checkbox-grid">
                <div class="checkbox-group">
                    <h4 id="group-basic"></h4>
                    <label><input type="checkbox" name="category" value="basic" checked> <span id="cat-basic"></span></label>
                </div>
                <div class="checkbox-group">
                    <h4 id="group-dakuten"></h4>
                    <label><input type="checkbox" name="category" value="dakuten"> <span id="cat-dakuten"></span></label>
                </div>
                <div class="checkbox-group">
                    <h4 id="group-handakuten"></h4>
                    <label><input type="checkbox" name="category" value="handakuten"> <span id="cat-handakuten"></span></label>
                </div>
                <div class="checkbox-group">
                    <h4 id="group-youon"></h4>
                    <label><input type="checkbox" name="category" value="youon"> <span id="cat-youon"></span></label>
                </div>
            </div>

            <button id="start-btn"></button>

            <!-- Quiz area -->
            <div id="quiz-area" style="display: none;">
                <!-- Progress bar -->
                <div class="progress-bar">
                    <div class="progress-fill" id="progress"></div>
                </div>
                
                <!-- Statistics info -->
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="current-num">1</div>
                        <div class="stat-label" id="stat-current"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-num">0</div>
                        <div class="stat-label" id="stat-total"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="score-num">0</div>
                        <div class="stat-label" id="stat-score"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="accuracy">0%</div>
                        <div class="stat-label" id="stat-accuracy"></div>
                    </div>
                </div>

                <!-- Quiz section -->
                <div class="quiz-container">
                    <div class="kana" id="kana"></div>
                    <input id="answer" placeholder="">
                    <button id="submit-btn"></button>
                    <div class="result" id="feedback"></div>
                    <img src="kabo-seed.gif" alt="Kabo Seed GIF" style="width:300px; height:auto; margin-top: 20px;">
                </div>
            </div>
        </div>

        <!-- Kana chart tab content -->
        <div id="chart-tab" class="tab-content">
            <div class="mode-select">
                <label>
                    <input type="radio" name="chart-type" value="hiragana" checked>
                    <span id="chart-hiragana-label"></span>
                </label>
                <label>
                    <input type="radio" name="chart-type" value="katakana">
                    <span id="chart-katakana-label"></span>
                </label>
            </div>
            <div id="kana-chart"></div>
            
            <!-- Concept display area -->
            <div style="margin: 30px 0;">
                <div class="checkbox-grid" style="pointer-events: none;">
                    <div class="checkbox-group" style="background: #f0f4ff; border: 2px solid #667eea;">
                        <h4 id="group-sokuon"></h4>
                        <p style="font-size: 14px; color: #666; margin: 5px 0; text-align: left;">
                            <span id="sokuon-desc"></span><br>
                            <span id="sokuon-example"></span>
                        </p>
                    </div>
                    <div class="checkbox-group" style="background: #f0f4ff; border: 2px solid #667eea;">
                        <h4 id="group-chouon"></h4>
                        <p style="font-size: 14px; color: #666; margin: 5px 0; text-align: left;">
                            <span id="chouon-desc"></span><br>
                            <span id="chouon-example"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Learning statistics tab content -->
        <div id="statistics-tab" class="tab-content">
            <div id="statistics-loading" style="text-align: center; padding: 40px; color: #666;">
                Loading...
            </div>
            
            <div id="statistics-content" style="display: none;">
                <!-- Overall statistics -->
                <div class="stats" id="overall-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="total-sessions-num">0</div>
                        <div class="stat-label" id="total-sessions-label"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-questions-num">0</div>
                        <div class="stat-label" id="total-questions-label"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-correct-num">0</div>
                        <div class="stat-label" id="total-correct-label"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="avg-accuracy-num">0%</div>
                        <div class="stat-label" id="avg-accuracy-label"></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-time-num">0</div>
                        <div class="stat-label" id="total-time-label"></div>
                    </div>
                </div>
                
                <!-- Recent practice sessions -->
                <div style="margin-top: 30px;">
                    <h3 id="recent-sessions-title"></h3>
                    <div id="recent-sessions-list"></div>
                </div>
                
                <!-- Category statistics -->
                <div style="margin-top: 30px;">
                    <h3 id="category-stats-title"></h3>
                    <div id="category-stats-list"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Practice session details modal -->
    <div id="session-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSessionDetail()">&times;</span>
            <h3 id="session-detail-title"></h3>
            <div id="session-detail-content">
                <div id="session-detail-loading">Loading...</div>
            </div>
        </div>
    </div>

    <script>
    // Complete kana data
    const kanaData = {
        basic: {
            hiragana: [
                ["あ","a"],["い","i"],["う","u"],["え","e"],["お","o"],
                ["か","ka"],["き","ki"],["く","ku"],["け","ke"],["こ","ko"],
                ["さ","sa"],["し","shi"],["す","su"],["せ","se"],["そ","so"],
                ["た","ta"],["ち","chi"],["つ","tsu"],["て","te"],["と","to"],
                ["な","na"],["に","ni"],["ぬ","nu"],["ね","ne"],["の","no"],
                ["は","ha"],["ひ","hi"],["ふ","fu"],["へ","he"],["ほ","ho"],
                ["ま","ma"],["み","mi"],["む","mu"],["め","me"],["も","mo"],
                ["や","ya"],["ゆ","yu"],["よ","yo"],
                ["ら","ra"],["り","ri"],["る","ru"],["れ","re"],["ろ","ro"],
                ["わ","wa"],["を","wo"],["ん","n"]
            ],
            katakana: [
                ["ア","a"],["イ","i"],["ウ","u"],["エ","e"],["オ","o"],
                ["カ","ka"],["キ","ki"],["ク","ku"],["ケ","ke"],["コ","ko"],
                ["サ","sa"],["シ","shi"],["ス","su"],["セ","se"],["ソ","so"],
                ["タ","ta"],["チ","chi"],["ツ","tsu"],["テ","te"],["ト","to"],
                ["ナ","na"],["ニ","ni"],["ヌ","nu"],["ネ","ne"],["ノ","no"],
                ["ハ","ha"],["ヒ","hi"],["フ","fu"],["ヘ","he"],["ホ","ho"],
                ["マ","ma"],["ミ","mi"],["ム","mu"],["メ","me"],["モ","mo"],
                ["ヤ","ya"],["ユ","yu"],["ヨ","yo"],
                ["ラ","ra"],["リ","ri"],["ル","ru"],["レ","re"],["ロ","ro"],
                ["ワ","wa"],["ヲ","wo"],["ン","n"]
            ]
        },
        dakuten: {
            hiragana: [
                ["が","ga"],["ぎ","gi"],["ぐ","gu"],["げ","ge"],["ご","go"],
                ["ざ","za"],["じ","ji/zi"],["ず","zu"],["ぜ","ze"],["ぞ","zo"],
                ["だ","da"],["ぢ","di/ji"],["づ","du/zu"],["で","de"],["ど","do"],
                ["ば","ba"],["び","bi"],["ぶ","bu"],["べ","be"],["ぼ","bo"]
            ],
            katakana: [
                ["ガ","ga"],["ギ","gi"],["グ","gu"],["ゲ","ge"],["ゴ","go"],
                ["ザ","za"],["ジ","ji/zi"],["ズ","zu"],["ゼ","ze"],["ゾ","zo"],
                ["ダ","da"],["ヂ","di/ji"],["ヅ","du/zu"],["デ","de"],["ド","do"],
                ["バ","ba"],["ビ","bi"],["ブ","bu"],["ベ","be"],["ボ","bo"]
            ]
        },
        handakuten: {
            hiragana: [
                ["ぱ","pa"],["ぴ","pi"],["ぷ","pu"],["ぺ","pe"],["ぽ","po"]
            ],
            katakana: [
                ["パ","pa"],["ピ","pi"],["プ","pu"],["ペ","pe"],["ポ","po"]
            ]
        },
        youon: {
            hiragana: [
                ["きゃ","kya"],["きゅ","kyu"],["きょ","kyo"],
                ["しゃ","sha"],["しゅ","shu"],["しょ","sho"],
                ["ちゃ","cha"],["ちゅ","chu"],["ちょ","cho"],
                ["にゃ","nya"],["にゅ","nyu"],["にょ","nyo"],
                ["ひゃ","hya"],["ひゅ","hyu"],["ひょ","hyo"],
                ["みゃ","mya"],["みゅ","myu"],["みょ","myo"],
                ["りゃ","rya"],["りゅ","ryu"],["りょ","ryo"],
                ["ぎゃ","gya"],["ぎゅ","gyu"],["ぎょ","gyo"],
                ["じゃ","ja"],["じゅ","ju"],["じょ","jo"],
                ["ぢゃ","dya"],["ぢゅ","dyu"],["ぢょ","dyo"],
                ["びゃ","bya"],["びゅ","byu"],["びょ","byo"],
                ["ぴゃ","pya"],["ぴゅ","pyu"],["ぴょ","pyo"]
            ],
            katakana: [
                ["キャ","kya"],["キュ","kyu"],["キョ","kyo"],
                ["シャ","sha"],["シュ","shu"],["ショ","sho"],
                ["チャ","cha"],["チュ","chu"],["チョ","cho"],
                ["ニャ","nya"],["ニュ","nyu"],["ニョ","nyo"],
                ["ヒャ","hya"],["ヒュ","hyu"],["ヒョ","hyo"],
                ["ミャ","mya"],["ミュ","myu"],["ミョ","myo"],
                ["リャ","rya"],["リュ","ryu"],["リョ","ryo"],
                ["ギャ","gya"],["ギュ","gyu"],["ギョ","gyo"],
                ["ジャ","ja"],["ジュ","ju"],["ジョ","jo"],
                ["ヂャ","dya"],["ヂュ","dyu"],["ヂョ","dyo"],
                ["ビャ","bya"],["ビュ","byu"],["ビョ","byo"],
                ["ピャ","pya"],["ピュ","pyu"],["ピョ","pyo"]
            ]
        }
    };

    // Kana chart data
    const chartData = {
        basic: [
            ["","a","i","u","e","o"],
            ["","あ/ア","い/イ","う/ウ","え/エ","お/オ"],
            ["k","か/カ","き/キ","く/ク","け/ケ","こ/コ"],
            ["s","さ/サ","し/シ","す/ス","せ/セ","そ/ソ"],
            ["t","た/タ","ち/チ","つ/ツ","て/テ","と/ト"],
            ["n","な/ナ","に/ニ","ぬ/ヌ","ね/ネ","の/ノ"],
            ["h","は/ハ","ひ/ヒ","ふ/フ","へ/ヘ","ほ/ホ"],
            ["m","ま/マ","み/ミ","む/ム","め/メ","も/モ"],
            ["y","や/ヤ","","ゆ/ユ","","よ/ヨ"],
            ["r","ら/ラ","り/リ","る/ル","れ/レ","ろ/ロ"],
            ["w","わ/ワ","","","","を/ヲ (wo/o)"],
            ["","","","","","ん/ン"]
        ],
        dakuten: [
            ["","a","i","u","e","o"],
            ["g","が/ガ","ぎ/ギ","ぐ/グ","げ/ゲ","ご/ゴ"],
            ["z","ざ/ザ","じ/ジ (ji/zi)","ず/ズ","ぜ/ゼ","ぞ/ゾ"],
            ["d","だ/ダ","ぢ/ヂ (di/ji)","づ/ヅ (du/zu)","で/デ","ど/ド"],
            ["b","ば/バ","び/ビ","ぶ/ブ","べ/ベ","ぼ/ボ"]
        ],
        handakuten: [
            ["","a","i","u","e","o"],
            ["p","ぱ/パ","ぴ/ピ","ぷ/プ","ぺ/ペ","ぽ/ポ"]
        ]
    };

    let selected = [], current = 0, score = 0, total = 0, lang = "zh";
    let questionStartTime = null; // Record start time for each question
    
    // Translation object moved to i18next (js/i18n.js)
    
    function translateType(type, language = getCurrentLanguage()) {
        // Use i18next translation system
        if (window.i18next && window.i18next.exists) {
            // First try to find in kana.categories
            if (i18next.exists(`kana.categories.${type}`)) {
                return t(`kana.categories.${type}`);
            }
            // Then try to find in kana.groups
            if (i18next.exists(`kana.groups.${type}`)) {
                return t(`kana.groups.${type}`);
            }
            // Try to find in kana.types
            if (i18next.exists(`kana.types.${type}`)) {
                return t(`kana.types.${type}`);
            }
        }
        // Finally return original value
        return type;
    }

    // Old translation object replaced by i18next (js/i18n.js)

    // Authentication page language switching function
    function setLanguageAndUpdateAuth() {
        const authLang = document.getElementById('auth-language').value;
        document.getElementById('language').value = authLang;
        setLanguage();
    }
    
    // Registration language preference switching function
    function onLanguagePreferenceChange() {
        const preferredLang = document.getElementById('register-language').value;
        document.getElementById('language').value = preferredLang;
        setLanguage();
    }
    
    // Initialize language settings (based on system language)
    function initializeLanguage() {
        let detectedLang = 'zh'; // Default Traditional Chinese
        
        // Try to get saved language preference from localStorage
        const savedLang = localStorage.getItem('preferredLanguage');
        if (savedLang && ['zh', 'en'].includes(savedLang)) {
            detectedLang = savedLang;
        } else {
            // Detect browser language settings
            const browserLang = navigator.language || navigator.userLanguage;
            console.log('Browser language detected:', browserLang);
            
            // Check if Chinese (including Traditional and Simplified)
            if (browserLang.startsWith('zh')) {
                detectedLang = 'zh';
            } else {
                detectedLang = 'en';
            }
        }
        
        // Set all language selectors
        const languageSelect = document.getElementById('language');
        const authLanguageSelect = document.getElementById('auth-language');
        const registerLanguageSelect = document.getElementById('register-language');
        
        if (languageSelect) languageSelect.value = detectedLang;
        if (authLanguageSelect) authLanguageSelect.value = detectedLang;
        if (registerLanguageSelect) registerLanguageSelect.value = detectedLang;
        
        // Save language preference
        localStorage.setItem('preferredLanguage', detectedLang);
        
        // Set global language
        lang = detectedLang;
        console.log('Language initialized to:', detectedLang);
    }

    // 同步所有語言選擇器
    function syncAllLanguageSelectors() {
        const currentLang = getCurrentLanguage();
        console.log("Syncing all language selectors to:", currentLang);
        
        // 同步主語言選擇器
        const mainLanguageSelect = document.getElementById('language');
        if (mainLanguageSelect && mainLanguageSelect.value !== currentLang) {
            mainLanguageSelect.value = currentLang;
        }
        
        // 同步認證頁面語言選擇器
        const authLanguageSelect = document.getElementById('auth-language');
        if (authLanguageSelect && authLanguageSelect.value !== currentLang) {
            authLanguageSelect.value = currentLang;
        }
        
        // 同步註冊頁面語言選擇器
        const registerLanguageSelect = document.getElementById('register-language');
        if (registerLanguageSelect && registerLanguageSelect.value !== currentLang) {
            registerLanguageSelect.value = currentLang;
        }
        
        // 同步練習模式語言選擇器
        const practiceLanguageSelect = document.getElementById('practice-language');
        if (practiceLanguageSelect && practiceLanguageSelect.value !== currentLang) {
            practiceLanguageSelect.value = currentLang;
        }
        
        // 同步錯題複習模式語言選擇器
        const reviewLanguageSelect = document.getElementById('review-language');
        if (reviewLanguageSelect && reviewLanguageSelect.value !== currentLang) {
            reviewLanguageSelect.value = currentLang;
        }
        
        console.log("All language selectors synced");
    }

    async function setLanguage() {
        console.log("setLanguage called");
        
        // Get language from main language selector
        const languageSelect = document.getElementById("language") || document.getElementById("language-select");
        if (languageSelect) {
            await changeLanguage(languageSelect.value);
        }
        
        console.log("Language set to:", getCurrentLanguage());
        syncAllLanguageSelectors();
        
        try {
            console.log("Language updated successfully");
            updateChart();
            
            // If currently on learning statistics page, reload statistics data to apply new language
            const statisticsTab = document.getElementById('statistics-tab');
            const activeNavTab = document.querySelector('.nav-tab[data-tab="statistics"].active');
            if ((statisticsTab && statisticsTab.style.display !== 'none' && statisticsTab.classList.contains('active')) || activeNavTab) {
                console.log("Reloading statistics for language change");
                setTimeout(() => loadStatistics(), 100);
            }
        } catch (error) {
            console.error("Error in setLanguage:", error);
        }
    }

    function showTab(tabName) {
        console.log("showTab called with:", tabName);
        
        // First hide all tab-content
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
            tab.style.display = 'none';
        });
        // First remove active from all nav-tabs
        document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

        // Show corresponding tab
        const currentTab = document.getElementById(tabName + '-tab');
        if (currentTab) {
            currentTab.classList.add('active');
            currentTab.style.display = 'block';
            console.log("Tab displayed:", tabName);
        } else {
            console.log("Tab not found:", tabName + '-tab');
        }
        
        // Add active to corresponding nav-tab
        const activeNavTab = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
        if (activeNavTab) {
            activeNavTab.classList.add('active');
            console.log("Nav tab activated:", tabName);
        }

        // Control start practice button display
        const startBtn = document.getElementById("start-btn");
        if (startBtn) {
            if (tabName === 'practice') {
                startBtn.style.display = "";
                startBtn.innerText = t('practice.startBtn');
                console.log("Start button shown");
            } else {
                startBtn.style.display = "none";
                console.log("Start button hidden");
            }
        }

        // 確保語言設定正確應用到當前標籤頁
        if (window.updateAllTexts) {
            updateAllTexts();
        }
        
        if (tabName === 'chart') {
            updateChart();
            console.log("Chart updated");
        } else if (tabName === 'statistics') {
            if (currentUser && authToken) {
                loadStatistics();
                console.log("Statistics loaded");
            } else {
                const loadingEl = document.getElementById('statistics-loading');
                if (loadingEl) {
                    loadingEl.textContent = t('stats.loginRequired');
                }
            }
        }
    }

    function updateKanaType() {
        // Logic can be added when kana type is updated
    }

    function shuffle(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    function startQuiz() {
        console.log("startQuiz called");
        
        try {
            // Clean up previous practice state
            const existingQuizArea = document.getElementById("quiz-area");
            if (existingQuizArea) {
                existingQuizArea.style.display = "none";
            }
            const inlineQuiz = document.getElementById("inline-quiz");
            if (inlineQuiz) {
                inlineQuiz.remove();
            }
            const existingQuizHeader = document.getElementById("quiz-header");
            if (existingQuizHeader) {
                existingQuizHeader.remove();
            }
            
            const kanaTypeEl = document.querySelector('input[name="kana-type"]:checked');
            if (!kanaTypeEl) {
                console.log("No kana type selected");
                return;
            }
            
            const kanaType = kanaTypeEl.value;
            // Security improvement: validate kanaType value
            if (!['hiragana', 'katakana', 'mixed'].includes(kanaType)) {
                console.error("Invalid kana type:", kanaType);
                return;
            }
            
            const categories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(cb => cb.value);
            
            if (categories.length === 0) {
                alert(t('practice.selectTypeAlert'));
                return;
            }

            let kanaList = [];
            categories.forEach(category => {
                // Security improvement: validate category value
                if (kanaData[category] && ['basic', 'dakuten', 'handakuten', 'youon'].includes(category)) {
                    if (kanaType === 'mixed') {
                        if (kanaData[category].hiragana) kanaList.push(...kanaData[category].hiragana);
                        if (kanaData[category].katakana) kanaList.push(...kanaData[category].katakana);
                    } else {
                        if (kanaData[category][kanaType]) kanaList.push(...kanaData[category][kanaType]);
                    }
                }
            });

            if (kanaList.length === 0) {
                console.log("No kana data found");
                return;
            }

            selected = shuffle(kanaList);
            current = 0;
            score = 0;
            total = selected.length;
            
            // Start practice session record for logged-in users
            if (currentUser) {
                startPracticeSession(kanaType, categories);
            }
            
            // Enter practice mode - hide main menu content, show practice content
            const practiceTab = document.getElementById("practice-tab");
            const chartTab = document.getElementById("chart-tab");
            const navTabs = document.querySelector(".nav-tabs");
            const languageSelect = document.querySelector('div[style*="margin-bottom: 20px"]');
            
            console.log("Hiding menu elements...");
            
            if (practiceTab) {
                // Hide options area
                const checkboxGrid = practiceTab.querySelector(".checkbox-grid");
                const modeSelect = practiceTab.querySelector(".mode-select");
                const startBtn = document.getElementById("start-btn");
                
                if (checkboxGrid) {
                    checkboxGrid.style.display = "none";
                    console.log("Checkbox grid hidden");
                }
                if (modeSelect) {
                    modeSelect.style.display = "none";
                    console.log("Mode select hidden");
                }
                if (startBtn) {
                    startBtn.style.display = "none";
                    console.log("Start button hidden");
                }
                if (navTabs) {
                    navTabs.style.display = "none";
                    console.log("Nav tabs hidden");
                }
                if (chartTab) {
                    chartTab.style.display = "none";
                    console.log("Chart tab hidden");
                }
                if (languageSelect) {
                    languageSelect.style.display = "none";
                    console.log("Language select hidden");
                }
                
                // Create practice page top navigation
                let quizHeader = document.createElement("div");
                quizHeader.id = "quiz-header";
                quizHeader.style.cssText = "display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 15px; background: rgba(255,255,255,0.9); border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);";
                
                const backButton = document.createElement("button");
                backButton.innerHTML = "← " + t('practice.backBtn');
                backButton.style.cssText = "background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;";
                backButton.onclick = returnToMenu;
                
                const title = document.createElement("h2");
                title.style.cssText = "margin: 0; color: #2c3e50;";
                title.innerText = t('practice.title');
                
                // Add language selector to practice mode header
                const languageContainer = document.createElement("div");
                languageContainer.style.cssText = "display: flex; align-items: center; gap: 8px;";
                
                const langLabel = document.createElement("label");
                langLabel.textContent = "🌐";
                langLabel.style.cssText = "font-size: 14px; color: #666;";
                
                const langSelect = document.createElement("select");
                langSelect.id = "practice-language";
                langSelect.style.cssText = "padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;";
                
                // Add language options
                const zhOption = document.createElement("option");
                zhOption.value = "zh";
                zhOption.textContent = getCurrentLanguage() === 'en' ? 'Chinese' : '中文';
                const enOption = document.createElement("option");
                enOption.value = "en";
                enOption.textContent = "English";
                
                langSelect.appendChild(zhOption);
                langSelect.appendChild(enOption);
                langSelect.value = getCurrentLanguage();
                
                // Add event listener for language change
                langSelect.addEventListener('change', async function() {
                    await changeLanguage(this.value);
                    syncAllLanguageSelectors();
                });
                
                languageContainer.appendChild(langLabel);
                languageContainer.appendChild(langSelect);
                
                quizHeader.appendChild(backButton);
                quizHeader.appendChild(title);
                quizHeader.appendChild(languageContainer);
                
                practiceTab.insertBefore(quizHeader, practiceTab.firstChild);
                console.log("Quiz header created");
            }
            
            // Force display quiz content
            console.log("Force showing quiz content...");
            
            // Directly display quiz area here
            const quizArea = document.getElementById("quiz-area");
            console.log("Direct quiz area check:", quizArea);
            
            if (quizArea) {
                quizArea.style.display = "block";
                quizArea.style.visibility = "visible";
                quizArea.style.opacity = "1";
                quizArea.style.position = "relative";
                quizArea.style.zIndex = "1000";
                quizArea.style.backgroundColor = "rgba(255,255,255,0.95)";
                quizArea.style.padding = "20px";
                quizArea.style.borderRadius = "10px";
                quizArea.style.marginTop = "20px";
                console.log("Quiz area shown directly with enhanced styles");
            } else {
                console.log("Quiz area NOT found - creating inline");
                // Directly create quiz content - use secure DOM API
                const practiceTab = document.getElementById("practice-tab");
                if (practiceTab) {
                    const inlineQuiz = document.createElement("div");
                    inlineQuiz.id = "inline-quiz";
                    
                    // 使用安全的 DOM API 而不是 innerHTML
                    const kanaDiv = document.createElement("div");
                    kanaDiv.id = "kana";
                    kanaDiv.style.cssText = "font-size: 72px; margin: 20px; color: #2c3e50; text-align: center;";
                    
                    const containerDiv = document.createElement("div");
                    containerDiv.style.cssText = "text-align: center; margin: 20px;";
                    
                    const answerInput = document.createElement("input");
                    answerInput.id = "answer";
                    answerInput.placeholder = t('practice.enterRomaji');
                    answerInput.style.cssText = "padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; margin: 5px;";
                    // 不要在這裡加事件監聽
                    
                    const submitBtn = document.createElement("button");
                    submitBtn.id = "submit-btn";
                    submitBtn.textContent = t('practice.submitAnswer');
                    submitBtn.style.cssText = "padding: 12px 24px; font-size: 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;";
                    // 不要在這裡加事件監聽
                    
                    const feedbackDiv = document.createElement("div");
                    feedbackDiv.id = "feedback";
                    feedbackDiv.style.cssText = "font-size: 18px; margin: 20px; font-weight: 500;";
                    
                    const img = document.createElement("img");
                    img.src = "kabo-seed.gif";
                    img.alt = "Kabo Seed GIF";
                    img.style.cssText = "width:300px; height:auto; margin-top: 20px;";
                    
                    // 組裝 DOM 結構
                    containerDiv.appendChild(answerInput);
                    containerDiv.appendChild(document.createElement("br"));
                    containerDiv.appendChild(document.createElement("br"));
                    containerDiv.appendChild(submitBtn);
                    containerDiv.appendChild(feedbackDiv);
                    containerDiv.appendChild(img);
                    
                    inlineQuiz.appendChild(kanaDiv);
                    inlineQuiz.appendChild(containerDiv);
                    
                    practiceTab.appendChild(inlineQuiz);
                    console.log("Inline quiz created using safe DOM API");
                    
                    // 重新設置事件監聽器（因為新創建的元素）
                    setupQuizEventListeners();
                }
            }
            
            const totalNumEl = document.getElementById("total-num");
            if (totalNumEl) {
                totalNumEl.innerText = total;
                console.log("Total number set to:", total);
            }
            
            console.log("Calling updateStats...");
            updateStats();
            console.log("Calling nextQuestion...");
            nextQuestion();
            console.log("Quiz started successfully");
            showQuizContent();
        } catch (error) {
            console.error("Error in startQuiz:", error);
            alert(t('common.error'));
        }
    }

    function showQuizContent() {
        // Ensure all practice-related elements are displayed
        const elementsToShow = [
            "progress", "current-num", "total-num", "score-num", "accuracy",
            "stat-current", "stat-total", "stat-score", "stat-accuracy",
            "kana", "answer", "submit-btn", "feedback"
        ];
        
        elementsToShow.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = "";
            }
        });
        
        // 確保進度條容器顯示
        const progressBar = document.querySelector(".progress-bar");
        if (progressBar) progressBar.style.display = "block";
        
        // 確保統計區域顯示
        const stats = document.querySelector(".stats");
        if (stats) stats.style.display = "flex";
        
        // 確保測驗容器顯示
        const quizContainer = document.querySelector(".quiz-container");
        if (quizContainer) quizContainer.style.display = "flex";
        
        // 確保咖波種子顯示
        const kaboImg = document.querySelector('img[alt="Kabo Seed GIF"]');
        if (kaboImg) {
            kaboImg.style.display = "block";
        }
    }

    function returnToMenu() {
        console.log("Returning to menu...");
        
        // Return to main menu - show main menu content, hide practice content
        const practiceTab = document.getElementById("practice-tab");
        const chartTab = document.getElementById("chart-tab");
        const navTabs = document.querySelector(".nav-tabs");
        const languageSelect = document.querySelector('div[style*="margin-bottom: 20px"]');
        const quizHeader = document.getElementById("quiz-header");
        
        if (practiceTab) {
            // 顯示選項區域
            const checkboxGrid = practiceTab.querySelector(".checkbox-grid");
            const modeSelect = practiceTab.querySelector(".mode-select");
            const startBtn = document.getElementById("start-btn");
            
            if (checkboxGrid) {
                checkboxGrid.style.display = "";
                console.log("Checkbox grid restored");
            }
            if (modeSelect) {
                modeSelect.style.display = "";
                console.log("Mode select restored");
            }
            if (startBtn) {
                startBtn.style.display = "";
                console.log("Start button restored");
            }
            if (navTabs) {
                navTabs.style.display = "";
                console.log("Nav tabs restored");
            }
            if (languageSelect) {
                languageSelect.style.display = "";
                console.log("Language select restored");
            }
            if (quizHeader) {
                quizHeader.style.display = "none";
                console.log("Quiz header hidden");
            }
        }
        
        // 修正：不要直接設 display: none，讓 tab 切換時自動管理
        if (chartTab) {
            chartTab.classList.remove('active');
            console.log("Chart tab reset (remove active class)");
        }
        
        // 隱藏測驗內容
        hideQuizContent();
        
        console.log("Returned to main menu");
    }

    function hideQuizContent() {
        // 隱藏 quiz-area
        const quizArea = document.getElementById("quiz-area");
        if (quizArea) quizArea.style.display = "none";

        // 隱藏進度條容器
        const progressBar = document.querySelector(".progress-bar");
        if (progressBar) progressBar.style.display = "none";
        
        // 隱藏統計區域
        const stats = document.querySelector(".stats");
        if (stats) stats.style.display = "none";
        
        // 隱藏測驗容器
        const quizContainer = document.querySelector(".quiz-container");
        if (quizContainer) quizContainer.style.display = "none";
        
        // 隱藏假名顯示
        const kanaEl = document.getElementById("kana");
        if (kanaEl) kanaEl.innerText = "";
        
        // 隱藏咖波種子
        const kaboImg = document.querySelector('img[alt="Kabo Seed GIF"]');
        if (kaboImg) {
            kaboImg.style.display = "none";
        }
        
        // 清除反饋
        const feedbackEl = document.getElementById("feedback");
        if (feedbackEl) feedbackEl.innerText = "";
    }

    function updateStats() {
        const currentEl = document.getElementById("current-num");
        const scoreEl = document.getElementById("score-num");
        const accuracyEl = document.getElementById("accuracy");
        const progressEl = document.getElementById("progress");
        
        if (currentEl) currentEl.innerText = current + 1;
        if (scoreEl) scoreEl.innerText = score;
        if (accuracyEl) accuracyEl.innerText = current > 0 ? Math.round(score / current * 100) + "%" : "0%";
        
        if (progressEl) {
            const progress = ((current) / total) * 100;
            progressEl.style.width = progress + "%";
        }
    }

    function nextQuestion() {
        console.log("nextQuestion called, current:", current, "total:", total);
        
        const kanaEl = document.getElementById("kana");
        const answerEl = document.getElementById("answer");
        const submitBtnEl = document.getElementById("submit-btn");
        const feedbackEl = document.getElementById("feedback");
        
        console.log("Kana element:", kanaEl);
        console.log("Answer element:", answerEl);
        
        if (current >= selected.length) {
            // 為登入用戶完成練習記錄
            if (currentUser && currentSessionId) {
                completePracticeSession(score, total);
            }
            
            if (kanaEl) {
                let finalMessage;
                
                // 檢查是否為錯題複習模式
                const isReviewMode = currentSessionId === null && document.getElementById('review-language');
                
                if (isReviewMode) {
                    finalMessage = `🔄 ${t('practice.reviewMode')} ${t('practice.practiceComplete')}！\n${t('common.score')}：${score} / ${total} (${Math.round(score/total*100)}%)`;
                } else {
                    finalMessage = `🌟 ${t('practice.practiceComplete')}！${t('common.score')}：${score} / ${total} (${Math.round(score/total*100)}%)`;
                }
                
                // 如果用戶未登入，添加警告訊息（但錯題複習模式不需要）
                if (!currentUser && !isReviewMode) {
                    finalMessage += `\n\n⚠️ ${t('app.guestWarning')}\n${t('common.loginToTrack')}`;
                }
                
                kanaEl.innerText = finalMessage;
                console.log(isReviewMode ? "Review mode completed" : "Practice completed");
            }
            if (answerEl) answerEl.style.display = "none";
            if (submitBtnEl) submitBtnEl.style.display = "none";
            if (feedbackEl) feedbackEl.innerText = "";
            
            // 如果用戶未登入，在反饋區域顯示登入提示
            if (!currentUser && feedbackEl) {
                feedbackEl.innerHTML = `<div style="background: rgba(255, 193, 7, 0.1); border: 1px solid #ffc107; border-radius: 6px; padding: 15px; margin-top: 20px;"><div style="color: #856404; font-weight: 500; margin-bottom: 10px;">${t('common.saveRecordsPrompt')}</div><div style="color: #856404; font-size: 14px; margin-bottom: 15px;">${t('common.registerPrompt')}</div><button onclick="showAuthScreen()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">${t('common.registerNow')}</button></div>`;
            }
            return;
        }
        
        if (kanaEl) {
            kanaEl.innerText = selected[current][0];
            questionStartTime = Date.now(); // 記錄本題開始時間
            console.log("Current kana set to:", selected[current][0]);
        }
        if (answerEl) {
            answerEl.value = "";
            answerEl.style.display = "inline";
            setTimeout(() => answerEl.focus(), 100);
            console.log("Answer input reset and focused");
        }
        if (submitBtnEl) submitBtnEl.style.display = "inline";
        if (feedbackEl) feedbackEl.innerText = "";
        
        updateStats();
    }

    function checkAnswer() {
        const answerEl = document.getElementById("answer");
        const feedbackEl = document.getElementById("feedback");
        
        if (!answerEl || !feedbackEl) return;
        
        // 安全性改進：輸入驗證與清理
        let user = answerEl.value.trim().toLowerCase();
        
        // 防止 XSS 攻擊：移除危險字符
        user = user.replace(/[<>\"'&]/g, '');
        
        // 限制輸入長度
        if (user.length > 50) {
            user = user.substring(0, 50);
        }
        
        // 只允許字母、數字和基本符號
        if (!/^[a-zA-Z0-9\s\/\-]+$/.test(user)) {
            feedbackEl.innerText = "⚠️ " + t('practice.enterRomaji');
            feedbackEl.style.color = "#e74c3c";
            return;
        }
        
        const char = selected[current][0];
        const correctAnswers = selected[current][1];
        const questionStartTime = Date.now(); // 記錄答題開始時間
        
        // 處理多種讀音的情況
        let acceptableAnswers = [];
        if (correctAnswers.includes('/')) {
            acceptableAnswers = correctAnswers.split('/');
        } else {
            acceptableAnswers = [correctAnswers];
        }
        
        // 特殊情況處理
        if (char === "を" || char === "ヲ") {
            acceptableAnswers = ["wo", "o"];
        }
        if (char === "ぢ" || char === "ヂ") {
            acceptableAnswers = ["di", "ji"];
        }
        if (char === "づ" || char === "ヅ") {
            acceptableAnswers = ["du", "zu"];
        }
        if (char === "じ" || char === "ジ") {
            acceptableAnswers = ["ji", "zi"];
        }
        
        const isCorrect = acceptableAnswers.includes(user);
        
        if (isCorrect) {
            feedbackEl.innerText = t('common.correct');
            feedbackEl.style.color = "#27ae60";
            score++;
        } else {
            const answerDisplay = acceptableAnswers.length > 1 ? 
                acceptableAnswers.join(' / ') : acceptableAnswers[0];
            feedbackEl.innerText = `❌ ${t('common.incorrect')}, ${t('sessionDetail.correct')}: ${answerDisplay}`;
            feedbackEl.style.color = "#e74c3c";
        }
        
        // 為登入用戶記錄答題
        if (currentUser) {
            const responseTime = questionStartTime ? Date.now() - questionStartTime : 0;
            recordAnswerWithTime(char, user, correctAnswers, isCorrect, responseTime);
        }
        
        current++;
        setTimeout(nextQuestion, 1500);
    }

    function updateChart() {
        console.log("updateChart called");
        
        const chartType = document.querySelector('input[name="chart-type"]:checked');
        if (!chartType) {
            console.log("No chart type selected, defaulting to hiragana");
            // 如果找不到選中的類型，默認為平假名
            const hiraganaRadio = document.querySelector('input[name="chart-type"][value="hiragana"]');
            if (hiraganaRadio) hiraganaRadio.checked = true;
        }
        
        const selectedType = chartType ? chartType.value : 'hiragana';
        console.log("Chart type:", selectedType);
        
        const chartContainer = document.getElementById("kana-chart");
        console.log("Chart container:", chartContainer);
        
        if (!chartContainer) {
            console.log("Chart container not found!");
            return;
        }
        
        let html = "";
        
        // 基本音表
        html += `<h3>${t('kana.categories.basic')}</h3>`;
        html += createChartTable(chartData.basic, selectedType);
        
        // 濁音表
        html += `<h3>${t('kana.categories.dakuten')}</h3>`;
        html += createChartTable(chartData.dakuten, selectedType);
        
        // 半濁音表
        html += `<h3>${t('kana.categories.handakuten')}</h3>`;
        html += createChartTable(chartData.handakuten, selectedType);
        
        // 拗音表
        html += `<h3>${t('kana.categories.youon')}</h3>`;
        html += createYouonTable(selectedType);
        
        console.log("Generated HTML length:", html.length);
        console.log("HTML preview:", html.substring(0, 200) + "...");
        
        // 安全性改進：使用 textContent 而不是 innerHTML（如果可能）
        // 由於這裡需要 HTML 格式，我們確保內容是安全的
        chartContainer.innerHTML = html;
        console.log("Chart container updated");
    }

    function createChartTable(data, type) {
        console.log("createChartTable called with type:", type);
        console.log("Data:", data);
        
        let html = '<table class="chart-table" style="width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">';
        
        data.forEach((row, index) => {
            html += '<tr>';
            row.forEach((cell, cellIndex) => {
                const cellStyle = index === 0 ? 
                    'style="padding: 12px; text-align: center; border: 1px solid #e9ecef; background: #667eea; color: white; font-weight: 600;"' :
                    'style="padding: 12px; text-align: center; border: 1px solid #e9ecef; font-size: 18px;"';
                
                if (index === 0) {
                    html += `<th ${cellStyle}>${cell}</th>`;
                } else {
                    if (cellIndex === 0) {
                        html += `<th ${cellStyle}>${cell}</th>`;
                    } else {
                        if (cell === "") {
                            html += '<td style="padding: 12px; text-align: center; border: 1px solid #e9ecef;"></td>';
                        } else {
                            // 檢查是否包含括號（多種讀音）
                            if (cell.includes('(')) {
                                // 有括號的情況，直接顯示
                                const kanaChars = cell.split(' (')[0].split('/');
                                const displayChar = type === 'hiragana' ? kanaChars[0] : kanaChars[1];
                                const romajiPart = cell.split(' (')[1].replace(')', '');
                                html += `<td style="padding: 12px; text-align: center; border: 1px solid #e9ecef;">
                                    <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${displayChar}</div>
                                    <div style="font-size: 14px; color: #666; font-family: monospace;">${romajiPart}</div>
                                </td>`;
                            } else {
                                // 普通情況，查找羅馬字
                                const kanaChars = cell.split('/');
                                const displayChar = type === 'hiragana' ? kanaChars[0] : kanaChars[1];
                                const romaji = getRomajiForKana(displayChar);
                                html += `<td style="padding: 12px; text-align: center; border: 1px solid #e9ecef;">
                                    <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${displayChar}</div>
                                    <div style="font-size: 14px; color: #666; font-family: monospace;">${romaji}</div>
                                </td>`;
                            }
                        }
                    }
                }
            });
            html += '</tr>';
        });
        
        html += '</table>';
        console.log("Generated table HTML length:", html.length);
        return html;
    }

    function createYouonTable(type) {
        const youonGroups = [
            {name: "きゃ行", kana: ["きゃ/キャ", "きゅ/キュ", "きょ/キョ"], romaji: ["kya", "kyu", "kyo"]},
            {name: "しゃ行", kana: ["しゃ/シャ", "しゅ/シュ", "しょ/ショ"], romaji: ["sha", "shu", "sho"]},
            {name: "ちゃ行", kana: ["ちゃ/チャ", "ちゅ/チュ", "ちょ/チョ"], romaji: ["cha", "chu", "cho"]},
            {name: "にゃ行", kana: ["にゃ/ニャ", "にゅ/ニュ", "にょ/ニョ"], romaji: ["nya", "nyu", "nyo"]},
            {name: "ひゃ行", kana: ["ひゃ/ヒャ", "ひゅ/ヒュ", "ひょ/ヒョ"], romaji: ["hya", "hyu", "hyo"]},
            {name: "みゃ行", kana: ["みゃ/ミャ", "みゅ/ミュ", "みょ/ミョ"], romaji: ["mya", "myu", "myo"]},
            {name: "りゃ行", kana: ["りゃ/リャ", "りゅ/リュ", "りょ/リョ"], romaji: ["rya", "ryu", "ryo"]},
            {name: "ぎゃ行", kana: ["ぎゃ/ギャ", "ぎゅ/ギュ", "ぎょ/ギョ"], romaji: ["gya", "gyu", "gyo"]},
            {name: "じゃ行", kana: ["じゃ/ジャ", "じゅ/ジュ", "じょ/ジョ"], romaji: ["ja", "ju", "jo"]},
            {name: "びゃ行", kana: ["びゃ/ビャ", "びゅ/ビュ", "びょ/ビョ"], romaji: ["bya", "byu", "byo"]},
            {name: "ぴゃ行", kana: ["ぴゃ/ピャ", "ぴゅ/ピュ", "ぴょ/ピョ"], romaji: ["pya", "pyu", "pyo"]}
        ];

        let html = '<table class="chart-table">';
        html += `<tr><th>${t('chart.tableRow')}</th><th>${t('chart.yaColumn')}</th><th>${t('chart.yuColumn')}</th><th>${t('chart.yoColumn')}</th></tr>`;
        
        youonGroups.forEach(group => {
            html += '<tr>';
            html += `<th>${group.name}</th>`;
            group.kana.forEach((kana, index) => {
                const kanaChars = kana.split('/');
                const displayChar = type === 'hiragana' ? kanaChars[0] : kanaChars[1];
                html += `<td>
                    <div class="kana-char">${displayChar}</div>
                    <div class="romaji">${group.romaji[index]}</div>
                </td>`;
            });
            html += '</tr>';
        });
        
        html += '</table>';
        return html;
    }

    function getRomajiForKana(kana) {
        // 查找假名對應的羅馬字
        for (const category in kanaData) {
            for (const type in kanaData[category]) {
                const found = kanaData[category][type].find(item => item[0] === kana);
                if (found) return found[1];
            }
        }
        return "";
    }

    // API 基礎設定
    const API_BASE_URL = 'http://127.0.0.1:8001/api';
    let currentUser = null;
    let authToken = null;
    
    // Learning record related variables
    let currentSessionId = null;
    let sessionStartTime = null;

    // Password show/hide functionality
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const toggleButton = input.nextElementSibling;
        
        if (input.type === 'password') {
            input.type = 'text';
            toggleButton.textContent = '🙈'; // 猴子遮眼的 emoji
        } else {
            input.type = 'password';
            toggleButton.textContent = '👁'; // 眼睛 emoji
        }
    }
    
    // Password validation functionality
    function validatePassword() {
        const password = document.getElementById('register-password').value;
        
        // 長度要求
        const lengthReq = document.getElementById('req-length');
        const lengthMet = password.length >= 8;
        updateRequirement(lengthReq, lengthMet);
        
        // 英文字母要求
        const letterReq = document.getElementById('req-letter');
        const letterMet = /[a-zA-Z]/.test(password);
        updateRequirement(letterReq, letterMet);
        
        // 數字要求
        const numberReq = document.getElementById('req-number');
        const numberMet = /[0-9]/.test(password);
        updateRequirement(numberReq, numberMet);
        
        return lengthMet && letterMet && numberMet;
    }
    
    function updateRequirement(element, isMet) {
        const icon = element.querySelector('.icon');
        if (isMet) {
            element.className = 'password-requirement requirement-met';
            icon.textContent = '✓';
        } else {
            element.className = 'password-requirement requirement-not-met';
            icon.textContent = '❌';
        }
    }

    // Authentication related functions
    async function apiCall(endpoint, method = 'GET', data = null) {
        const config = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
        };

        if (authToken) {
            config.headers['Authorization'] = `Bearer ${authToken}`;
        }

        if (data) {
            config.body = JSON.stringify(data);
        }

        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || `HTTP error! status: ${response.status}`);
            }
            
            return result;
        } catch (error) {
            console.error('API call failed:', error);
            throw error;
        }
    }
    
    // Learning record API functions
    async function startPracticeSession(sessionType, categories) {
        if (!currentUser || !authToken) {
            console.log('User not logged in, not recording learning data');
            return null;
        }
        
        try {
            const response = await apiCall('/practice/sessions/start/', 'POST', {
                session_type: sessionType,
                categories: categories
            });
            
            if (response.success) {
                currentSessionId = response.session_id;
                sessionStartTime = new Date();
                console.log('Practice session started:', currentSessionId);
                return response.session_id;
            }
        } catch (error) {
            console.error('Failed to start practice session:', error);
        }
        return null;
    }
    
    async function recordAnswerWithTime(questionKana, userAnswer, correctRomaji, isCorrect, responseTime) {
        if (!currentUser || !authToken || !currentSessionId) {
            return;
        }
        
        try {
            await apiCall('/practice/answers/', 'POST', {
                session_id: currentSessionId,
                question_kana: questionKana,
                user_answer: userAnswer,
                correct_romaji: correctRomaji,
                response_time_ms: responseTime
            });
            console.log('Answer recorded:', questionKana, userAnswer, isCorrect);
        } catch (error) {
            console.error('Failed to record answer:', error);
        }
    }
    
    async function completePracticeSession(finalScore, totalQuestions) {
        if (!currentUser || !authToken || !currentSessionId) {
            return;
        }
        
        try {
            const endTime = new Date();
            const durationSeconds = Math.round((endTime - sessionStartTime) / 1000);
            const accuracyRate = Math.round((finalScore / totalQuestions) * 100);
            
            const response = await apiCall(`/practice/sessions/${currentSessionId}/complete/`, 'POST', {
                total_questions: totalQuestions,
                correct_answers: finalScore,
                accuracy_rate: accuracyRate,
                duration_seconds: durationSeconds
            });
            
            if (response.success) {
                console.log('Practice session completed');
            }
            
            // Clear current session
            currentSessionId = null;
            sessionStartTime = null;
            
        } catch (error) {
            console.error('Failed to complete practice session:', error);
        }
    }
    
    async function getLearningStatistics() {
        if (!currentUser || !authToken) {
            return null;
        }
        
        try {
            const response = await apiCall('/practice/statistics/', 'GET');
            if (response.success) {
                return response;
            }
        } catch (error) {
            console.error('Failed to load learning statistics:', error);
        }
        return null;
    }
    
    // 載入學習統計頁面
    async function loadStatistics() {
        console.log('loadStatistics called, currentUser:', currentUser, 'authToken:', !!authToken);
        
        const loadingEl = document.getElementById('statistics-loading');
        const contentEl = document.getElementById('statistics-content');
        
        if (loadingEl) {
            loadingEl.style.display = 'block';
            loadingEl.textContent = t('common.loading');
        }
        if (contentEl) contentEl.style.display = 'none';
        
        if (!currentUser || !authToken) {
            console.log('No user or token, showing login message');
            if (loadingEl) loadingEl.textContent = t('stats.loginRequired');
            return;
        }
        
        const stats = await getLearningStatistics();
        console.log('Statistics received:', stats);
        
        if (stats) {
            // 更新總體統計
            const overall = stats.overall;
            document.getElementById('total-sessions-num').textContent = overall.total_sessions;
            document.getElementById('total-questions-num').textContent = overall.total_questions;
            document.getElementById('total-correct-num').textContent = overall.total_correct;
            document.getElementById('avg-accuracy-num').textContent = overall.avg_accuracy + '%';
            document.getElementById('total-time-num').textContent = overall.total_time_minutes;
            
            // 顯示最近練習記錄
            const recentList = document.getElementById('recent-sessions-list');
            if (recentList && stats.recent_sessions) {
                let html = '';
                stats.recent_sessions.forEach(session => {
                    const date = new Date(session.started_at).toLocaleDateString();
                    const time = new Date(session.started_at).toLocaleTimeString();
                    const sessionTypeText = translateType(session.session_type);
                    const categoriesText = session.categories.map(cat => translateType(cat)).join(', ');
                    
                    html += `<div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 6px; cursor: pointer; transition: background 0.2s;" 
                             onclick="showSessionDetail(${session.id})" 
                             onmouseover="this.style.background='#e9ecef'" 
                             onmouseout="this.style.background='#f8f9fa'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${sessionTypeText}</strong> - ${categoriesText}
                                <br><small>${date} ${time}</small>
                                <br><small style="color: #667eea;">${t('stats.clickForDetail')}</small>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #667eea; font-weight: bold;">${session.accuracy_rate}%</div>
                                <small>${session.correct_answers}/${session.total_questions}</small>
                            </div>
                        </div>
                    </div>`;
                });
                recentList.innerHTML = html;
            }
            
            // 顯示各類別統計
            const categoryList = document.getElementById('category-stats-list');
            if (categoryList && stats.by_category) {
                let html = '';
                stats.by_category.forEach(category => {
                    const kanaTypeText = translateType(category.kana_type) || category.kana_type;
                    const categoryText = translateType(category.category) || category.category;
                    const timesText = t('common.times');
                    const totalPracticeText = t('stats.totalPractice');
                    
                    html += `<div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${kanaTypeText}</strong> - ${categoryText}
                            <br><small>${totalPracticeText}: ${category.total_attempts} ${timesText}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #667eea; font-weight: bold;">${category.accuracy_rate}%</div>
                            <small>${category.correct_attempts}/${category.total_attempts}</small>
                        </div>
                    </div>`;
                });
                categoryList.innerHTML = html;
            }
            
            if (loadingEl) loadingEl.style.display = 'none';
            if (contentEl) contentEl.style.display = 'block';
        } else {
            if (loadingEl) loadingEl.textContent = t('stats.cannotLoad');
        }
    }
    
    // 顯示練習記錄詳情
    async function showSessionDetail(sessionId) {
        const modal = document.getElementById('session-detail-modal');
        const content = document.getElementById('session-detail-content');
        const loading = document.getElementById('session-detail-loading');
        
        if (!modal) return;
        
        modal.style.display = 'block';
        if (loading) loading.style.display = 'block';
        
        // 使用 i18next t() 函數替代舊的 texts[lang]
        
        // 更新模態視窗標題和載入文字
        const titleEl = document.getElementById('session-detail-title');
        const loadingTextEl = document.getElementById('session-detail-loading');
        
        if (titleEl) titleEl.textContent = t('sessionDetail.title');
        if (loadingTextEl) loadingTextEl.textContent = t('common.loading');
        
        try {
            const response = await apiCall(`/practice/sessions/${sessionId}/`, 'GET');
            
            if (response.success) {
                const session = response.session;
                const sessionTypeText = translateType(session.session_type);
                const categoriesText = session.categories.map(cat => translateType(cat)).join(', ');
                const startDate = new Date(session.started_at);
                const endDate = new Date(session.completed_at);
                
                const typeLabel = t('sessionDetail.practiceType');
                const rangeLabel = t('sessionDetail.practiceRange');
                const startLabel = t('sessionDetail.startTime');
                const endLabel = t('sessionDetail.endTime');
                const durationLabel = t('sessionDetail.duration');
                const resultLabel = t('sessionDetail.result');
                const recordsLabel = t('sessionDetail.answerRecords');
                const detailTitle = t('sessionDetail.title');
                const minuteText = t('common.minutes');
                
                let detailHtml = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">${detailTitle}</h4>
                        <p><strong>${typeLabel}:</strong> ${sessionTypeText}</p>
                        <p><strong>${rangeLabel}:</strong> ${categoriesText}</p>
                        <p><strong>${startLabel}:</strong> ${startDate.toLocaleString()}</p>
                        <p><strong>${endLabel}:</strong> ${endDate.toLocaleString()}</p>
                        <p><strong>${durationLabel}:</strong> ${Math.round(session.duration_seconds / 60)} ${minuteText}</p>
                        <p><strong>${resultLabel}:</strong> ${session.correct_answers}/${session.total_questions} (${session.accuracy_rate}%)</p>
                    </div>
                    
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">${recordsLabel}</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                `;
                
                // 顯示所有答題記錄
                if (session.answer_records && session.answer_records.length > 0) {
                    session.answer_records.forEach((record, index) => {
                        const isCorrect = record.is_correct;
                        const recordClass = isCorrect ? 'answer-correct' : 'answer-incorrect';
                        const icon = isCorrect ? '✓' : '✗';
                        const responseTime = (record.response_time_ms / 1000).toFixed(1);
                        
                        detailHtml += `
                            <div class="answer-record ${recordClass}">
                                <div>
                                    <span class="kana-large">${record.question_kana}</span>
                                    <span style="margin-left: 10px; color: #666;">${t('sessionDetail.correct')}: ${record.correct_romaji}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div>
                                        <span style="font-weight: bold;">${icon} ${record.user_answer}</span>
                                        <span style="margin-left: 10px; font-size: 12px; color: #666;">${responseTime}s</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    // 錯題複習按鈕
                    const wrongAnswers = session.answer_records.filter(record => !record.is_correct);
                    if (wrongAnswers.length > 0) {
                        detailHtml += `
                            <div style="margin-top: 20px; text-align: center;">
                                <button onclick="startReviewSession(${sessionId})" 
                                        style="background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
${t('sessionDetail.reviewWrongAnswers')} (${wrongAnswers.length} ${t('common.questions')})
                                </button>
                            </div>
                        `;
                    }
                } else {
                    detailHtml += `<p style="text-align: center; color: #666;">${t('sessionDetail.noAnswerRecords')}</p>`;
                }
                
                detailHtml += '</div>';
                
                if (loading) loading.style.display = 'none';
                if (content) content.innerHTML = detailHtml;
            }
        } catch (error) {
            console.error('Failed to load session details:', error);
            if (loading) loading.style.display = 'none';
            if (content) content.innerHTML = `<p style="color: #e74c3c; text-align: center;">${t('sessionDetail.cannotLoadDetails')}</p>`;
        }
    }
    
    // 關閉詳情模態視窗
    function closeSessionDetail() {
        document.getElementById('session-detail-modal').style.display = 'none';
    }
    
    // 錯題複習功能
    async function startReviewSession(sessionId) {
        try {
            const response = await apiCall(`/practice/sessions/${sessionId}/`, 'GET');
            
            if (response.success) {
                const session = response.session;
                const wrongAnswers = session.answer_records.filter(record => !record.is_correct);
                
                if (wrongAnswers.length > 0) {
                    // 準備錯題複習數據
                    const reviewData = wrongAnswers.map(record => [record.question_kana, record.correct_romaji]);
                    
                    // 關閉模態視窗
                    closeSessionDetail();
                    
                    // 切換到練習模式並開始錯題複習
                    showTab('practice');
                    startReviewQuiz(reviewData, session.session_type);
                }
            }
        } catch (error) {
            console.error('Wrong answer review failed:', error);
            alert(t('sessionDetail.reviewFailed'));
        }
    }
    
    // 開始錯題複習
    function startReviewQuiz(reviewData, sessionType) {
        selected = shuffle(reviewData);
        current = 0;
        score = 0;
        total = selected.length;
        
        // Wrong answer review not recorded to database, just practice
        currentSessionId = null;
        
        // Hide options area, show practice content
        const practiceTab = document.getElementById("practice-tab");
        const chartTab = document.getElementById("chart-tab");
        const navTabs = document.querySelector(".nav-tabs");
        const languageSelect = document.querySelector('div[style*="margin-bottom: 20px"]');
        
        if (practiceTab) {
            const checkboxGrid = practiceTab.querySelector(".checkbox-grid");
            const modeSelect = practiceTab.querySelector(".mode-select");
            const startBtn = document.getElementById("start-btn");
            
            if (checkboxGrid) checkboxGrid.style.display = "none";
            if (modeSelect) modeSelect.style.display = "none";
            if (startBtn) startBtn.style.display = "none";
            if (navTabs) navTabs.style.display = "none";
            if (chartTab) chartTab.style.display = "none";
            if (languageSelect) languageSelect.style.display = "none";
            
            // Create wrong answer review title
            let quizHeader = document.createElement("div");
            quizHeader.id = "quiz-header";
            quizHeader.style.cssText = "display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 15px; background: rgba(255,200,200,0.9); border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 2px solid #e74c3c;";
            
            const backButton = document.createElement("button");
            backButton.innerHTML = "← " + t('practice.backBtn');
            backButton.style.cssText = "background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;";
            backButton.onclick = returnToMenu;
            
            const titleContainer = document.createElement("div");
            titleContainer.style.cssText = "text-align: center;";
            
            const title = document.createElement("h2");
            title.style.cssText = "margin: 0; color: #e74c3c; display: flex; align-items: center; gap: 8px;";
            title.innerHTML = "🔄 " + t('practice.reviewMode');
            
            const subtitle = document.createElement("div");
            subtitle.style.cssText = "font-size: 12px; color: #666; margin-top: 4px;";
            subtitle.textContent = `${total} ${t('common.questions')}`;
            
            titleContainer.appendChild(title);
            titleContainer.appendChild(subtitle);
            
            // Add language selector to review mode header
            const languageContainer = document.createElement("div");
            languageContainer.style.cssText = "display: flex; align-items: center; gap: 8px;";
            
            const langLabel = document.createElement("label");
            langLabel.textContent = "🌐";
            langLabel.style.cssText = "font-size: 14px; color: #666;";
            
            const langSelect = document.createElement("select");
            langSelect.id = "review-language";
            langSelect.style.cssText = "padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;";
            
            // Add language options
            const zhOption = document.createElement("option");
            zhOption.value = "zh";
            zhOption.textContent = getCurrentLanguage() === 'en' ? 'Chinese' : '中文';
            const enOption = document.createElement("option");
            enOption.value = "en";
            enOption.textContent = "English";
            
            langSelect.appendChild(zhOption);
            langSelect.appendChild(enOption);
            langSelect.value = getCurrentLanguage();
            
            // Add event listener for language change
            langSelect.addEventListener('change', async function() {
                await changeLanguage(this.value);
                syncAllLanguageSelectors();
                // Update review mode UI
                updateReviewModeTexts();
            });
            
            languageContainer.appendChild(langLabel);
            languageContainer.appendChild(langSelect);
            
            quizHeader.appendChild(backButton);
            quizHeader.appendChild(titleContainer);
            quizHeader.appendChild(languageContainer);
            
            practiceTab.insertBefore(quizHeader, practiceTab.firstChild);
        }
        
        // 確保測驗區域存在，如果不存在則創建
        let quizArea = document.getElementById("quiz-area");
        if (!quizArea) {
            console.log("Creating quiz area for review mode...");
            quizArea = document.createElement("div");
            quizArea.id = "quiz-area";
            quizArea.style.cssText = "display: block;";
            
            // 創建進度條
            const progressBar = document.createElement("div");
            progressBar.className = "progress-bar";
            progressBar.style.cssText = "width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; margin-bottom: 20px; overflow: hidden;";
            
            const progressFill = document.createElement("div");
            progressFill.className = "progress-fill";
            progressFill.id = "progress";
            progressFill.style.cssText = "height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s ease;";
            
            progressBar.appendChild(progressFill);
            
            // 創建統計區域
            const stats = document.createElement("div");
            stats.className = "stats";
            stats.style.cssText = "display: flex; justify-content: space-around; margin-bottom: 30px; background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);";
            
            const statItems = [
                { id: "current-num", labelId: "stat-current", value: "1" },
                { id: "total-num", labelId: "stat-total", value: total.toString() },
                { id: "score-num", labelId: "stat-score", value: "0" },
                { id: "accuracy", labelId: "stat-accuracy", value: "0%" }
            ];
            
            statItems.forEach(item => {
                const statItem = document.createElement("div");
                statItem.className = "stat-item";
                statItem.style.cssText = "text-align: center;";
                
                const statNumber = document.createElement("div");
                statNumber.className = "stat-number";
                statNumber.id = item.id;
                statNumber.style.cssText = "font-size: 24px; font-weight: bold; color: #2c3e50;";
                statNumber.textContent = item.value;
                
                const statLabel = document.createElement("div");
                statLabel.className = "stat-label";
                statLabel.id = item.labelId;
                statLabel.style.cssText = "font-size: 14px; color: #666;";
                
                statItem.appendChild(statNumber);
                statItem.appendChild(statLabel);
                stats.appendChild(statItem);
            });
            
            // 創建測驗容器
            const quizContainer = document.createElement("div");
            quizContainer.className = "quiz-container";
            quizContainer.style.cssText = "display: flex; flex-direction: column; align-items: center; text-align: center; background: rgba(255,255,255,0.95); padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);";
            
            // 創建假名顯示
            const kanaDiv = document.createElement("div");
            kanaDiv.className = "kana";
            kanaDiv.id = "kana";
            kanaDiv.style.cssText = "font-size: 72px; margin: 20px; color: #2c3e50; text-align: center; font-weight: bold;";
            
            // 創建答案輸入框
            const answerInput = document.createElement("input");
            answerInput.id = "answer";
            answerInput.placeholder = t('practice.enterRomaji');
            answerInput.style.cssText = "padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; margin: 10px; width: 200px; text-align: center;";
            answerInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    checkAnswer();
                }
            });
            
            // 創建提交按鈕
            const submitBtn = document.createElement("button");
            submitBtn.id = "submit-btn";
            submitBtn.textContent = t('practice.submitAnswer');
            submitBtn.style.cssText = "padding: 12px 24px; font-size: 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 10px;";
            submitBtn.addEventListener('click', checkAnswer);
            
            // 創建反饋區域
            const feedbackDiv = document.createElement("div");
            feedbackDiv.className = "result";
            feedbackDiv.id = "feedback";
            feedbackDiv.style.cssText = "font-size: 18px; margin: 20px; font-weight: 500; min-height: 25px;";
            
            // 創建咖波圖片
            const kaboImg = document.createElement("img");
            kaboImg.src = "kabo-seed.gif";
            kaboImg.alt = "Kabo Seed GIF";
            kaboImg.style.cssText = "width: 300px; height: auto; margin-top: 20px;";
            
            // 組裝所有元素
            quizContainer.appendChild(kanaDiv);
            quizContainer.appendChild(answerInput);
            quizContainer.appendChild(submitBtn);
            quizContainer.appendChild(feedbackDiv);
            quizContainer.appendChild(kaboImg);
            
            quizArea.appendChild(progressBar);
            quizArea.appendChild(stats);
            quizArea.appendChild(quizContainer);
            
            practiceTab.appendChild(quizArea);
            console.log("Quiz area created for review mode");
            
            // 立即更新新創建元素的文字
            updateDynamicPracticeElements();
        } else {
            quizArea.style.display = "block";
            console.log("Quiz area already exists, showing it");
        }
        
        const totalNumEl = document.getElementById("total-num");
        if (totalNumEl) totalNumEl.innerText = total;
        
        updateStats();
        nextQuestion();
        showQuizContent();
    }
    
    // 更新錯題複習模式的文字
    function updateReviewModeTexts() {
        const quizHeader = document.getElementById('quiz-header');
        if (quizHeader) {
            const backButton = quizHeader.querySelector('button');
            const title = quizHeader.querySelector('h2');
            const subtitle = quizHeader.querySelector('div[style*="font-size: 12px"]');
            
            if (backButton) backButton.innerHTML = "← " + t('practice.backBtn');
            if (title) title.innerHTML = "🔄 " + t('practice.reviewMode');
            if (subtitle) subtitle.textContent = `${total} ${t('common.questions')}`;
        }
        
        // 更新答案輸入框和提交按鈕
        const answerInput = document.getElementById('answer');
        const submitBtn = document.getElementById('submit-btn');
        if (answerInput) answerInput.placeholder = t('practice.enterRomaji');
        if (submitBtn) submitBtn.textContent = t('practice.submitAnswer');
        
        // 同步語言選擇器
        const reviewLanguageSelect = document.getElementById('review-language');
        if (reviewLanguageSelect) {
            reviewLanguageSelect.value = getCurrentLanguage();
        }
    }

    function showMessage(elementId, message, isError = false) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.className = isError ? 'error-message' : 'success-message';
        
        // 3秒後清除訊息
        setTimeout(() => {
            element.textContent = '';
            element.className = '';
        }, 3000);
    }

    function switchAuthTab(tabName) {
        // 切換標籤活動狀態
        document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        // 切換表單顯示
        document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
        document.getElementById(`${tabName}-form`).classList.add('active');
    }

    async function handleLogin(event) {
        event.preventDefault();
        
        const identifier = document.getElementById('login-identifier').value;
        const password = document.getElementById('login-password').value;
        const button = document.getElementById('login-button');
        
        button.disabled = true;
        button.textContent = t('auth.loggingIn');
        
        try {
            const response = await apiCall('/auth/login/', 'POST', {
                identifier: identifier,
                password: password
            });
            
            if (response.success) {
                authToken = response.token;
                currentUser = response.user;
                
                // 儲存到 localStorage
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                showAuthenticatedApp();
                showMessage('login-message', t('common.success'));
            }
        } catch (error) {
            showMessage('login-message', error.message || t('common.error'), true);
        } finally {
            button.disabled = false;
            button.textContent = t('app.login');
        }
    }

    async function handleRegister(event) {
        event.preventDefault();
        
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const displayName = document.getElementById('register-display-name').value;
        const password = document.getElementById('register-password').value;
        const passwordConfirm = document.getElementById('register-password-confirm').value;
        const button = document.getElementById('register-button');
        
        if (password !== passwordConfirm) {
            showMessage('register-message', t('auth.passwordMismatch'), true);
            return;
        }
        
        button.disabled = true;
        button.textContent = t('auth.registering');
        
        const preferredLanguage = document.getElementById('register-language').value;
        
        try {
            const response = await apiCall('/auth/register/', 'POST', {
                username: username,
                email: email,
                display_name: displayName,
                password: password,
                password_confirm: passwordConfirm,
                preferred_language: preferredLanguage
            });
            
            if (response.success) {
                authToken = response.token;
                currentUser = response.user;
                
                // 儲存到 localStorage
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                showAuthenticatedApp();
                showMessage('register-message', t('common.success'));
            }
        } catch (error) {
            const errorMessage = error.message || t('common.error');
            showMessage('register-message', errorMessage, true);
        } finally {
            button.disabled = false;
            button.textContent = t('app.register');
        }
    }

    // Google OAuth 功能
    function initGoogleSignIn() {
        if (!isGoogleOAuthConfigured()) {
            console.log('Google OAuth not configured');
            return;
        }
        
        if (typeof google === 'undefined') {
            console.log('Google Sign-In API not loaded');
            setTimeout(initGoogleSignIn, 1000);
            return;
        }

        // 初始化 Google Sign-In
        google.accounts.id.initialize({
            client_id: appConfig.googleClientId,
            callback: handleGoogleLoginCallback,
            auto_select: false,
            cancel_on_tap_outside: true,
            origin: window.location.origin
        });

        // 渲染登入按鈕
        const loginButton = document.getElementById('google-signin-button');
        if (loginButton) {
            google.accounts.id.renderButton(loginButton, {
                theme: 'outline',
                size: 'large',
                text: 'signin_with',
                shape: 'rectangular',
                logo_alignment: 'left'
            });
        }

        // 渲染註冊按鈕
        const registerButton = document.getElementById('google-register-button');
        if (registerButton) {
            google.accounts.id.renderButton(registerButton, {
                theme: 'filled_blue',
                size: 'large',
                text: 'signup_with',
                shape: 'rectangular',
                logo_alignment: 'left'
            });
        }
    }

    function updateGoogleOAuthVisibility() {
        const elements = [
            document.querySelector('.oauth-divider'),
            document.getElementById('google-signin-button'),
            document.querySelector('.oauth-divider:nth-of-type(2)'),
            document.getElementById('google-register-button')
        ];
        
        const isConfigured = isGoogleOAuthConfigured();
        elements.forEach(el => {
            if (el) el.style.display = isConfigured ? 'block' : 'none';
        });
    }

    async function handleGoogleLoginCallback(response) {
        console.log('Google login callback received:', response);
        
        try {
            const result = await apiCall('/auth/oauth/google/', 'POST', {
                token: response.credential
            });
            
            if (result.success) {
                authToken = result.token;
                currentUser = result.user;
                
                // 儲存到 localStorage
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                if (result.is_new_user) {
                    // 新用戶導向個人資料設定頁面
                    showGoogleProfileSetup();
                } else {
                    // 現有用戶直接進入應用
                    showAuthenticatedApp();
                    showMessage('login-message', t('auth.googleLoginSuccess'));
                }
            }
        } catch (error) {
            console.error('Google OAuth error:', error);
            showMessage('login-message', error.message || t('common.error'), true);
        }
    }

    // Google 個人資料設定頁面
    function showGoogleProfileSetup() {
        // 隱藏主應用和認證頁面
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('auth-screen').classList.add('hidden');
        
        // 顯示 Google 設定頁面
        document.getElementById('google-profile-setup').classList.remove('hidden');
        
        // 更新頁面文字
        updateGoogleProfileTexts();
        
        // 預填用戶資訊
        if (currentUser) {
            document.getElementById('google-nickname').value = currentUser.display_name || '';
            document.getElementById('google-language').value = currentUser.preferred_language || getCurrentLanguage();
        }
    }

    function updateGoogleProfileTexts() {
        const elements = {
            'complete-profile-title': 'auth.completeProfile',
            'google-nickname-label': 'auth.nickname',
            'google-birth-date-label': 'auth.birthDate',
            'google-language-label': 'auth.preferredLanguage',
            'skip-setup-btn': 'auth.skipSetup',
            'save-profile-btn': 'auth.saveProfile'
        };
        
        Object.entries(elements).forEach(([id, key]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = t(key);
        });
        
        // 更新subtitle
        const subtitle = document.getElementById('complete-profile-subtitle');
        if (subtitle && currentUser) {
            subtitle.textContent = getCurrentLanguage() === 'en' ? 
                `Welcome, ${currentUser.email}! Please complete your profile.` : 
                `歡迎，${currentUser.email}！請完成您的個人資料。`;
        }
        
        // 更新 placeholder
        const nicknameInput = document.getElementById('google-nickname');
        if (nicknameInput) nicknameInput.placeholder = t('auth.nicknamePlaceholder');
        
        // 更新語言選擇器
        updateGoogleLanguageSelector();
    }

    function updateGoogleLanguageSelector() {
        const languageSelect = document.getElementById('google-language');
        if (languageSelect) {
            const currentValue = languageSelect.value;
            languageSelect.innerHTML = '';
            
            const zhOption = document.createElement('option');
            zhOption.value = 'zh';
            zhOption.textContent = getCurrentLanguage() === 'en' ? 'Chinese' : '中文';
            
            const enOption = document.createElement('option');
            enOption.value = 'en';
            enOption.textContent = 'English';
            
            languageSelect.appendChild(zhOption);
            languageSelect.appendChild(enOption);
            languageSelect.value = currentValue || getCurrentLanguage();
        }
    }

    async function skipGoogleSetup() {
        showAuthenticatedApp();
        showMessage('google-profile-message', t('auth.googleRegisterSuccess'));
    }

    async function handleGoogleProfileSubmit(event) {
        event.preventDefault();
        
        const nickname = document.getElementById('google-nickname').value;
        const birthDate = document.getElementById('google-birth-date').value;
        const language = document.getElementById('google-language').value;
        const button = document.getElementById('save-profile-btn');
        
        button.disabled = true;
        
        try {
            const result = await apiCall('/auth/profile/update/', 'PUT', {
                display_name: nickname,
                birth_date: birthDate,
                preferred_language: language
            });
            
            if (result.success) {
                currentUser = result.user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // 如果語言有變更，更新界面語言
                if (language !== getCurrentLanguage()) {
                    await changeLanguage(language);
                }
                
                showAuthenticatedApp();
                showMessage('google-profile-message', t('auth.googleRegisterSuccess'));
            }
        } catch (error) {
            showMessage('google-profile-message', error.message || t('common.error'), true);
        } finally {
            button.disabled = false;
        }
    }

    function showAuthenticatedApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('google-profile-setup').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        
        // 顯示用戶資訊，隱藏遊客訊息
        document.getElementById('user-info').style.display = 'block';
        document.getElementById('guest-info').style.display = 'none';
        
        // 顯示統計標籤
        const statisticsNavTab = document.getElementById('statistics-nav-tab');
        if (statisticsNavTab) statisticsNavTab.style.display = 'block';
        
        // 更新用戶資訊顯示
        if (currentUser) {
            document.getElementById('user-name').textContent = currentUser.display_name || currentUser.username;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('user-avatar').textContent = (currentUser.display_name || currentUser.username).charAt(0).toUpperCase();
        }
    }

    function showAuthScreen() {
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
    }
    
    function showGuestApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        
        // 顯示遊客訊息，隱藏用戶資訊
        document.getElementById('user-info').style.display = 'none';
        document.getElementById('guest-info').style.display = 'block';
        
        // 隱藏統計標籤
        const statisticsNavTab = document.getElementById('statistics-nav-tab');
        if (statisticsNavTab) statisticsNavTab.style.display = 'none';
    }

    function logout() {
        authToken = null;
        currentUser = null;
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');
        showGuestApp();
        
        // 清空表單
        document.getElementById('login-form').reset();
        document.getElementById('register-form').reset();
    }

    function checkAuthStatus() {
        const storedToken = localStorage.getItem('authToken');
        const storedUser = localStorage.getItem('currentUser');
        
        if (storedToken && storedUser) {
            authToken = storedToken;
            try {
                currentUser = JSON.parse(storedUser);
                showAuthenticatedApp();
            } catch (error) {
                console.error('Failed to parse stored user data:', error);
                showGuestApp();
            }
        } else {
            showGuestApp();
        }
    }

    function setupAuthEventListeners() {
        // 認證標籤切換
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                switchAuthTab(tab.getAttribute('data-auth-tab'));
            });
        });
        
        // 登入表單
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        
        // 註冊表單
        document.getElementById('register-form').addEventListener('submit', handleRegister);
        
        // Google 個人資料表單
        document.getElementById('google-profile-form').addEventListener('submit', handleGoogleProfileSubmit);
        
        // 登出按鈕
        document.getElementById('logout-btn').addEventListener('click', logout);
    }

    // 初始化
    async function initializePage() {
        // 初始化 i18next
        await initI18n();
        
        // 設置語言選擇器
        const languageSelect = document.getElementById('language-select');
        if (languageSelect) {
            languageSelect.value = getCurrentLanguage();
            languageSelect.addEventListener('change', async (e) => {
                await changeLanguage(e.target.value);
            });
        }
        
        // 更新所有文字
        updateAllTexts();
        updateChart();
        
        // 更新 Google OAuth 可見性
        updateGoogleOAuthVisibility();
        
        // 初始化 Google Sign-In
        initGoogleSignIn();
        
        // 設置認證事件監聽器
        setupAuthEventListeners();
        
        // 檢查認證狀態
        checkAuthStatus();
        
        // 綁定所有事件監聽器
        setupEventListeners();
        
        console.log("Page initialized with i18next"); // Debug info
    }
    
    // 設置所有事件監聽器
    function setupEventListeners() {
        console.log("Setting up event listeners...");
        
        // 開始練習按鈕
        const startBtn = document.getElementById("start-btn");
        if (startBtn) {
            // 移除舊的事件監聽器（如果有的話）
            startBtn.removeEventListener('click', startQuiz);
            startBtn.addEventListener('click', startQuiz);
            console.log("Start button event listener added");
        } else {
            console.log("Start button not found");
        }
        
        // 語言選擇
        const languageSelect = document.getElementById("language");
        if (languageSelect) {
            // 移除舊的事件監聽器（如果有的話）
            languageSelect.removeEventListener('change', setLanguage);
            languageSelect.addEventListener('change', setLanguage);
            console.log("Language select event listener added");
        } else {
            console.log("Language select not found");
        }
        
        // 導航標籤
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => {
            // 移除舊的事件監聽器（如果有的話）
            tab.removeEventListener('click', tabClickHandler);
            tab.addEventListener('click', tabClickHandler);
        });
        console.log("Nav tabs event listeners added:", navTabs.length);
        
        // 假名類型選擇
        const kanaTypeRadios = document.querySelectorAll('input[name="kana-type"]');
        kanaTypeRadios.forEach(radio => {
            // 移除舊的事件監聽器（如果有的話）
            radio.removeEventListener('change', updateCategoryLabels);
            radio.addEventListener('change', updateCategoryLabels);
        });
        console.log("Kana type radios event listeners added:", kanaTypeRadios.length);
        
        // 五十音表類型選擇
        const chartTypeRadios = document.querySelectorAll('input[name="chart-type"]');
        chartTypeRadios.forEach(radio => {
            // 移除舊的事件監聽器（如果有的話）
            radio.removeEventListener('change', updateChart);
            radio.addEventListener('change', updateChart);
        });
        console.log("Chart type radios event listeners added:", chartTypeRadios.length);
        
        // 答案輸入框和送出按鈕（這些可能在動態創建時才存在）
        setupQuizEventListeners();
        
        console.log("All event listeners set up successfully");
    }
    
    // 設置測驗相關的事件監聽器
    function setupQuizEventListeners() {
        // 答案輸入框
        const answerInput = document.getElementById("answer");
        if (answerInput) {
            // 移除舊的事件監聽器（如果有的話）
            answerInput.removeEventListener('keydown', answerKeydownHandler);
            answerInput.addEventListener('keydown', answerKeydownHandler);
            console.log("Answer input event listener added");
        }
        
        // 送出按鈕
        const submitBtn = document.getElementById("submit-btn");
        if (submitBtn) {
            // 移除舊的事件監聽器（如果有的話）
            submitBtn.removeEventListener('click', checkAnswer);
            submitBtn.addEventListener('click', checkAnswer);
            console.log("Submit button event listener added");
        }
    }
    
    // 導航標籤點擊處理器
    function tabClickHandler() {
        const tabName = this.getAttribute('data-tab');
        console.log("Tab clicked:", tabName);
        showTab(tabName);
    }
    
    // 答案輸入框按鍵處理器
    function answerKeydownHandler(event) {
        if (event.key === 'Enter') {
            console.log("Enter key pressed in answer input");
            checkAnswer();
        }
    }
    
    // 更新類別標籤
    function updateCategoryLabels() {
        const kanaType = document.querySelector('input[name="kana-type"]:checked').value;
        
        const catBasic = document.getElementById('cat-basic');
        const catDakuten = document.getElementById('cat-dakuten');
        const catHandakuten = document.getElementById('cat-handakuten');
        const catYouon = document.getElementById('cat-youon');
        
        if (catBasic) catBasic.textContent = t('kana.categories.basicWithExample');
        
        if (kanaType === 'katakana') {
            if (catDakuten) catDakuten.textContent = t('kana.categories.dakutenKatakana');
            if (catHandakuten) catHandakuten.textContent = t('kana.categories.handakutenKatakana');
            if (catYouon) catYouon.textContent = t('kana.categories.youonKatakana');
        } else {
            if (catDakuten) catDakuten.textContent = t('kana.categories.dakutenWithExample');
            if (catHandakuten) catHandakuten.textContent = t('kana.categories.handakutenWithExample');
            if (catYouon) catYouon.textContent = t('kana.categories.youonWithExample');
        }
    }
    
    // 當頁面加載完成時初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePage);
    } else {
        initializePage();
    }
    </script>
</body>
</html>
